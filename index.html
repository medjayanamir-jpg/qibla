<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Qibla</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans:wght@300;400;600;700&display=swap');
  :root{--gold:#C9A84C;--gold-l:#E8D48B;--gold-d:#9A7B2E;--bg:#0B1D15;--text:#F0ECE0;--dim:rgba(240,236,224,.5)}
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{overscroll-behavior:none;overflow:hidden}
  body{font-family:'Noto Sans',sans-serif;background:var(--bg);color:var(--text);height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center}
  body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 90% 70% at 50% 25%,rgba(26,107,74,.2) 0%,transparent 70%);pointer-events:none}
  .app{display:flex;flex-direction:column;align-items:center;padding:16px;position:relative;z-index:1;width:100%}
  .hd{text-align:center;margin-bottom:8px}
  .hd .ar{font-family:'Amiri',serif;font-size:22px;color:var(--gold)}
  .hd h1{font-family:'Amiri',serif;font-size:22px;margin-top:2px}
  .hd .city{font-size:12px;color:var(--dim);margin-top:3px} .hd .city b{color:var(--text)}
  .deg{font-family:'Amiri',serif;font-size:52px;font-weight:700;color:var(--gold-l);text-align:center;margin:8px 0 4px}
  .deg .sm{font-size:18px;color:var(--dim);font-weight:400;margin-left:4px}
  .hint{font-size:11px;color:var(--dim);text-align:center;margin-bottom:12px;display:flex;align-items:center;gap:5px;justify-content:center}
  .hint .dot{width:6px;height:6px;border-radius:50%;background:#4CAF50;animation:blink 1.5s infinite}
  .hint.off .dot{background:#666;animation:none}
  .cmp{position:relative;width:min(300px,82vw);height:min(300px,82vw);margin:0 auto}
  .cmp-bg{position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle at 45% 40%,rgba(26,107,74,.08),rgba(10,26,20,.95) 70%);border:2px solid rgba(201,168,76,.2);box-shadow:0 0 50px rgba(26,107,74,.12),inset 0 0 40px rgba(0,0,0,.4)}
  .arrow{position:absolute;inset:0;z-index:20;pointer-events:none}
  .dial{position:absolute;inset:0;z-index:10}
  .dial svg{width:100%;height:100%}
  .ibar{display:flex;gap:10px;margin-top:16px;width:100%;max-width:330px}
  .ib{flex:1;background:rgba(26,107,74,.1);border:1px solid rgba(201,168,76,.1);border-radius:12px;padding:9px 10px;text-align:center;backdrop-filter:blur(6px)}
  .ib .l{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);font-weight:600}
  .ib .v{font-family:'Amiri',serif;font-size:19px;color:var(--gold-l);font-weight:700;margin-top:2px}
  .ib .v .u{font-size:11px;color:var(--dim);font-weight:400}
  .aligned{font-size:13px;text-align:center;margin-top:10px;color:#4CAF50;font-weight:600;opacity:0;transition:opacity .3s}
  .aligned.show{opacity:1;animation:pulse 1s infinite}
  .ft{margin-top:14px;text-align:center;font-size:9px;color:rgba(240,236,224,.18);line-height:1.4}
  .ld{text-align:center;padding:60px 20px}
  .sp{width:44px;height:44px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 14px}
  .ld p{font-size:13px;color:var(--dim)} .er{color:#E87C6C}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
</style>
</head>
<body>
<div class="app" id="app">
  <div id="ct">
    <div class="ld"><div class="sp"></div><p id="lt">–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...</p></div>
  </div>
</div>
<script>
/* ‚ïê‚ïê‚ïê KAABA ‚Äî consensus coordinates from multiple authoritative sources ‚ïê‚ïê‚ïê */
const KAABA={lat:21.422487,lng:39.826206};
const R=6371;

/* ‚ïê‚ïê‚ïê TELEGRAM ‚ïê‚ïê‚ïê */
try{const tg=window.Telegram&&window.Telegram.WebApp;if(tg){tg.ready();tg.expand();tg.headerColor='#0B1D15';tg.backgroundColor='#0B1D15'}}catch(e){}
const P=new URLSearchParams(location.search);
const pCity=P.get('city')||'',pLat=parseFloat(P.get('lat')),pLng=parseFloat(P.get('lng')),pLang=P.get('lang')||'ru';

/* ‚ïê‚ïê‚ïê i18n ‚ïê‚ïê‚ïê */
const L={
  ru:{ld:'–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...',qibla:'–ö–∏–±–ª–∞',dist:'–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ',dir:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
      on:'–ö–æ–º–ø–∞—Å –∞–∫—Ç–∏–≤–µ–Ω ¬∑ –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –∫ –ö–∏–±–ª–µ',off:'–í–∫–ª—é—á–∏—Ç–µ –∫–æ–º–ø–∞—Å ‚Äî –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω ‚àû',
      face:'‚úÖ –í—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –∫ –ö–∏–±–ª–µ!',km:'–∫–º',
      err:'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',den:'–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏',
      dirs:['–°','–°–°–í','–°–í','–í–°–í','–í','–í–Æ–í','–Æ–í','–Æ–Æ–í','–Æ','–Æ–Æ–ó','–Æ–ó','–ó–Æ–ó','–ó','–ó–°–ó','–°–ó','–°–°–ó']},
  uz:{ld:'Joylashuv aniqlanmoqda...',qibla:'Qibla',dist:'Masofa',dir:'Yo\'nalish',
      on:'Kompas faol ¬∑ Qiblaga qarating',off:'Kompasni yoqing ‚Äî telefonni ‚àû aylantiring',
      face:'‚úÖ Siz Qiblaga qarab turibsiz!',km:'km',
      err:'Joylashuvni aniqlab bo\'lmadi',den:'Geolokatsiyaga ruxsat bering',
      dirs:['Sh','ShShSh','ShSh','ShShSh','Sh','ShJSh','JSh','JJSh','J','JJG','JG','GJG','G','GShG','ShG','ShShG']},
  en:{ld:'Detecting location...',qibla:'Qibla',dist:'Distance',dir:'Direction',
      on:'Compass active ¬∑ turn toward Qibla',off:'Enable compass ‚Äî move phone in ‚àû',
      face:'‚úÖ You are facing Qibla!',km:'km',
      err:'Unable to detect location',den:'Allow geolocation access',
      dirs:['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW']}
};
const t=L[pLang]||L.ru;
document.getElementById('lt').textContent=t.ld;

/* ‚ïê‚ïê‚ïê MATH ‚ïê‚ïê‚ïê */
const toRad=d=>d*Math.PI/180,toDeg=r=>r*180/Math.PI;
function qiblaAngle(lat,lng){
  const f=toRad(lat),fK=toRad(KAABA.lat),dL=toRad(KAABA.lng-lng);
  let q=toDeg(Math.atan2(Math.sin(dL),Math.cos(f)*Math.tan(fK)-Math.sin(f)*Math.cos(dL)));
  return q<0?q+360:q;
}
function haversine(lat,lng){
  const f1=toRad(lat),f2=toRad(KAABA.lat),df=toRad(KAABA.lat-lat),dl=toRad(KAABA.lng-lng);
  const a=Math.sin(df/2)**2+Math.cos(f1)*Math.cos(f2)*Math.sin(dl/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function cDir(b){return t.dirs[Math.round(b/22.5)%16]}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMPASS ENGINE ‚Äî cross-platform absolute heading
   
   PROBLEM: On many Android browsers, `deviceorientation` gives
   RELATIVE alpha (0¬∞ = where phone pointed when page loaded).
   It drifts and resets on reload ‚Äî that's why "it works after
   refresh" but then goes wrong.
   
   SOLUTION:
   1. Android: Use `deviceorientationabsolute` event (gives true
      north heading). Fall back to `deviceorientation` with
      `event.absolute===true` check.
   2. iOS: Use `webkitCompassHeading` (always absolute).
   3. Low-pass filter for smooth, stable rotation.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let qAngle=0, smoothHeading=0, rawHeading=null, compassOk=false;
let lastDialAngle=0; // for shortest-path rotation

// Low-pass filter: smooths jitter, Œ±=0.3 is responsive but stable
function lowPass(oldVal,newVal,alpha){
  // Handle 0/360 wraparound
  let diff=newVal-oldVal;
  if(diff>180)diff-=360;
  if(diff<-180)diff+=360;
  return(oldVal+alpha*diff+360)%360;
}

function onHeading(h){
  if(h===null||isNaN(h))return;
  rawHeading=h;
  smoothHeading=compassOk?lowPass(smoothHeading,h,0.25):h;
  compassOk=true;
  updateDial();
  const hint=document.getElementById('hint');
  if(hint&&!hint.dataset.on){
    hint.classList.remove('off');
    hint.querySelector('.tx').textContent=t.on;
    hint.dataset.on='1';
  }
}

/* Handler for orientation events */
function handleOrientation(e){
  let h=null;
  // iOS: webkitCompassHeading is always absolute (0=North)
  if(e.webkitCompassHeading!==undefined&&e.webkitCompassHeading!==null){
    h=e.webkitCompassHeading;
  }
  // Android absolute: alpha is absolute when event.absolute===true
  else if(e.absolute===true&&e.alpha!==null){
    h=(360-e.alpha)%360;
  }
  // Fallback: non-absolute alpha (UNRELIABLE for compass, but better than nothing)
  else if(e.alpha!==null){
    h=(360-e.alpha)%360;
  }
  if(h!==null)onHeading(h);
}

function startCompass(){
  // PRIORITY 1: deviceorientationabsolute (Chrome Android ‚Äî TRUE north)
  if('ondeviceorientationabsolute' in window || window.DeviceOrientationAbsoluteEvent){
    window.addEventListener('deviceorientationabsolute',handleOrientation,true);
  }
  
  // PRIORITY 2: deviceorientation (iOS uses this + webkitCompassHeading)
  if(window.DeviceOrientationEvent){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      // iOS 13+ requires permission
      DeviceOrientationEvent.requestPermission().then(s=>{
        if(s==='granted'){
          window.addEventListener('deviceorientation',handleOrientation,true);
        }
      }).catch(()=>{});
    }else{
      window.addEventListener('deviceorientation',handleOrientation,true);
    }
  }
}

/* ‚ïê‚ïê‚ïê DIAL ROTATION ‚ïê‚ïê‚ïê
   Arrow = FIXED (always points UP)
   Dial = ROTATES by (qiblaAngle - heading)
   When user faces Qibla ‚Üí heading ‚âà qiblaAngle ‚Üí rotation ‚âà 0 ‚Üí N at top
*/
function updateDial(){
  const dial=document.getElementById('dial');
  if(!dial)return;
  
  const targetAngle=qAngle-smoothHeading;
  
  // Shortest path rotation to avoid 360‚Üí0 jumps
  let diff=targetAngle-lastDialAngle;
  if(diff>180)diff-=360;
  if(diff<-180)diff+=360;
  lastDialAngle+=diff;
  
  dial.style.transform=`rotate(${lastDialAngle}deg)`;

  // Detect alignment: user faces Qibla within ¬±5¬∞
  const d=Math.abs(((smoothHeading-qAngle)%360+540)%360-180);
  const el=document.getElementById('aligned');
  if(el){
    if(d<5)el.classList.add('show');
    else el.classList.remove('show');
  }
}

/* ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê */
function render(lat,lng,city){
  qAngle=qiblaAngle(lat,lng);
  const d=haversine(lat,lng);
  const dir=cDir(qAngle);
  const S=300,cx=S/2,cy=S/2;
  let ticks='';
  for(let i=0;i<360;i+=5){
    const major=i%30===0,mid=i%15===0;
    const r1=major?125:(mid?130:133),r2=142,a=toRad(i-90);
    ticks+=`<line x1="${cx+r1*Math.cos(a)}" y1="${cy+r1*Math.sin(a)}" x2="${cx+r2*Math.cos(a)}" y2="${cy+r2*Math.sin(a)}" stroke="${major?'rgba(201,168,76,.6)':'rgba(201,168,76,.15)'}" stroke-width="${major?1.5:.5}"/>`;
  }
  let cSvg='';
  [[0,'N','rgba(201,168,76,.85)',16],[90,'E','rgba(201,168,76,.4)',13],[180,'S','rgba(201,168,76,.4)',13],[270,'W','rgba(201,168,76,.4)',13]].forEach(([a,l,c,fs])=>{
    const r=110,ar=toRad(a-90);
    cSvg+=`<text x="${cx+r*Math.cos(ar)}" y="${cy+r*Math.sin(ar)+5}" text-anchor="middle" fill="${c}" font-family="Amiri,serif" font-size="${fs}" font-weight="700">${l}</text>`;
  });
  [30,60,120,150,210,240,300,330].forEach(dg=>{
    const r=98,ar=toRad(dg-90);
    cSvg+=`<text x="${cx+r*Math.cos(ar)}" y="${cy+r*Math.sin(ar)+3}" text-anchor="middle" fill="rgba(201,168,76,.2)" font-family="Noto Sans" font-size="8">${dg}¬∞</text>`;
  });

  document.getElementById('ct').innerHTML=`
    <div class="hd">
      <div class="ar">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê</div>
      <h1>üïã ${t.qibla}</h1>
      ${city?`<div class="city">üìç <b>${decodeURIComponent(city)}</b></div>`:''}
    </div>
    <div class="deg">${qAngle.toFixed(1)}¬∞<span class="sm">${dir}</span></div>
    <div class="hint off" id="hint"><div class="dot"></div><span class="tx">${t.off}</span></div>
    <div class="cmp">
      <div class="cmp-bg"></div>
      <svg class="arrow" viewBox="0 0 ${S} ${S}">
        <defs>
          <linearGradient id="ag" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#E8D48B"/><stop offset="100%" stop-color="#9A7B2E"/></linearGradient>
          <filter id="gw"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <g filter="url(#gw)">
          <polygon points="${cx},22 ${cx-15},${cy-12} ${cx},${cy-28} ${cx+15},${cy-12}" fill="url(#ag)"/>
          <polygon points="${cx},${S-22} ${cx-11},${cy+12} ${cx},${cy+28} ${cx+11},${cy+12}" fill="rgba(201,168,76,.12)"/>
        </g>
        <text x="${cx}" y="16" text-anchor="middle" font-size="22">üïã</text>
        <circle cx="${cx}" cy="${cy}" r="6" fill="#0B1D15" stroke="#C9A84C" stroke-width="2"/>
        <circle cx="${cx}" cy="${cy}" r="2.2" fill="#C9A84C"/>
      </svg>
      <div class="dial" id="dial" style="transform:rotate(${qAngle}deg)">
        <svg viewBox="0 0 ${S} ${S}">${ticks}${cSvg}</svg>
      </div>
    </div>
    <div class="aligned" id="aligned">${t.face}</div>
    <div class="ibar">
      <div class="ib"><div class="l">${t.dir}</div><div class="v">${dir}</div></div>
      <div class="ib"><div class="l">${t.dist}</div><div class="v">${d.toFixed(0)}<span class="u"> ${t.km}</span></div></div>
      <div class="ib"><div class="l">${t.qibla}</div><div class="v">${qAngle.toFixed(1)}¬∞</div></div>
    </div>
    <div class="ft">Kaaba: 21.42249¬∞N, 39.82621¬∞E ¬∑ Great-Circle</div>
  `;
  lastDialAngle=qAngle; // init rotation state
  startCompass();
}

function showErr(m){document.getElementById('ct').innerHTML=`<div class="ld"><p class="er">‚ö†Ô∏è ${m}</p></div>`}

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
(function(){
  if(!isNaN(pLat)&&!isNaN(pLng)){render(pLat,pLng,pCity);return}
  if(!navigator.geolocation){showErr(t.err);return}
  navigator.geolocation.getCurrentPosition(
    p=>render(p.coords.latitude,p.coords.longitude,pCity||''),
    e=>showErr(e.code===1?t.den:t.err),
    {enableHighAccuracy:true,timeout:8000,maximumAge:60000}
  );
})();
</script>
</body>
</html>
