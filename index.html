<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Qibla & Tasbih</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans:wght@300;400;600;700&display=swap');
  :root{--gold:#C9A84C;--gold-l:#E8D48B;--gold-d:#9A7B2E;--bg:#0B1D15;--text:#F0ECE0;--dim:rgba(240,236,224,.5)}
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{overscroll-behavior:none;overflow:hidden}
  body{font-family:'Noto Sans',sans-serif;background:var(--bg);color:var(--text);height:100dvh;display:flex;flex-direction:column}
  body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 90% 70% at 50% 25%,rgba(26,107,74,.2) 0%,transparent 70%);pointer-events:none}

  .tabs{display:flex;width:100%;max-width:400px;margin:0 auto;position:relative;z-index:30;padding:8px 16px 0;flex-shrink:0}
  .tab{flex:1;text-align:center;padding:10px 0 8px;font-size:14px;font-weight:600;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;transition:all .25s;user-select:none}
  .tab.active{color:var(--gold-l);border-bottom-color:var(--gold)} .tab:active{opacity:.7}

  .page{display:none;flex:1;flex-direction:column;align-items:center;overflow-y:auto;overflow-x:hidden;position:relative;z-index:1;padding:12px 16px 24px}
  .page.active{display:flex}

  .hd{text-align:center;margin-bottom:6px}
  .hd .ar{font-family:'Amiri',serif;font-size:20px;color:var(--gold)}
  .hd h1{font-family:'Amiri',serif;font-size:20px;margin-top:1px}
  .hd .city{font-size:11px;color:var(--dim);margin-top:2px} .hd .city b{color:var(--text)}
  .deg{font-family:'Amiri',serif;font-size:46px;font-weight:700;color:var(--gold-l);text-align:center;margin:4px 0 2px}
  .deg .sm{font-size:16px;color:var(--dim);font-weight:400;margin-left:4px}
  .hint{font-size:10px;color:var(--dim);text-align:center;margin-bottom:10px;display:flex;align-items:center;gap:5px;justify-content:center}
  .hint .dot{width:5px;height:5px;border-radius:50%;background:#4CAF50;animation:blink 1.5s infinite}
  .hint.off .dot{background:#666;animation:none}
  .cmp{position:relative;width:min(270px,74vw);height:min(270px,74vw);margin:0 auto}
  .cmp-bg{position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle at 45% 40%,rgba(26,107,74,.08),rgba(10,26,20,.95) 70%);border:2px solid rgba(201,168,76,.2);box-shadow:0 0 40px rgba(26,107,74,.1),inset 0 0 30px rgba(0,0,0,.4)}
  .arrow{position:absolute;inset:0;z-index:20;pointer-events:none}
  .dial{position:absolute;inset:0;z-index:10;will-change:transform} .dial svg{width:100%;height:100%}
  .ibar{display:flex;gap:8px;margin-top:12px;width:100%;max-width:320px}
  .ib{flex:1;background:rgba(26,107,74,.1);border:1px solid rgba(201,168,76,.1);border-radius:10px;padding:7px 8px;text-align:center}
  .ib .l{font-size:8px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);font-weight:600}
  .ib .v{font-family:'Amiri',serif;font-size:17px;color:var(--gold-l);font-weight:700;margin-top:1px}
  .ib .v .u{font-size:10px;color:var(--dim);font-weight:400}
  .aligned{
    font-size:18px;text-align:center;margin-top:10px;
    color:#4ddb8a;font-weight:700;opacity:0;
    transition:opacity .4s;letter-spacing:.02em;
    text-shadow:0 0 12px rgba(77,219,138,.7),0 0 28px rgba(77,219,138,.4);
    filter:drop-shadow(0 0 6px rgba(77,219,138,.6))
  }
  .aligned.show{opacity:1;animation:glowPulse 1.4s ease-in-out infinite}
  @keyframes glowPulse{
    0%,100%{text-shadow:0 0 12px rgba(77,219,138,.7),0 0 28px rgba(77,219,138,.4);transform:scale(1)}
    50%{text-shadow:0 0 22px rgba(77,219,138,1),0 0 50px rgba(77,219,138,.7),0 0 80px rgba(77,219,138,.3);transform:scale(1.04)}
  }

  /* TASBIH */
  .tasbih-page{justify-content:center;gap:0}
  .dhikr-selector{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:16px;max-width:340px}
  .dhikr-btn{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;background:rgba(26,107,74,.15);border:1px solid rgba(201,168,76,.15);color:var(--dim);cursor:pointer;transition:all .2s;user-select:none;font-family:'Noto Sans',sans-serif}
  .dhikr-btn.active{background:rgba(201,168,76,.2);border-color:var(--gold);color:var(--gold-l)} .dhikr-btn:active{transform:scale(.95)}
  .tasbih-display{text-align:center;margin-bottom:8px}
  .tasbih-arabic{font-family:'Amiri',serif;font-size:28px;color:var(--gold);margin-bottom:2px;min-height:38px}
  .tasbih-translit{font-size:12px;color:var(--dim);min-height:18px}
  .tasbih-meaning{font-size:10px;color:rgba(240,236,224,.35);margin-top:2px;min-height:16px}
  .counter-wrap{position:relative;width:220px;height:220px;margin:12px auto;cursor:pointer;user-select:none;-webkit-user-select:none}
  .counter-wrap:active .tap-area{transform:scale(.97)}
  .progress-ring{position:absolute;inset:0;transform:rotate(-90deg)}
  .progress-bg{fill:none;stroke:rgba(201,168,76,.1);stroke-width:6}
  .progress-bar{fill:none;stroke:var(--gold);stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset .15s ease}
  .tap-area{position:absolute;inset:12px;border-radius:50%;background:radial-gradient(circle at 45% 40%,rgba(26,107,74,.15),rgba(10,26,20,.9));border:2px solid rgba(201,168,76,.2);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:transform .1s;box-shadow:0 0 30px rgba(26,107,74,.1),inset 0 0 20px rgba(0,0,0,.3)}
  .count-num{font-family:'Amiri',serif;font-size:64px;font-weight:700;color:var(--gold-l);line-height:1}
  .count-target{font-size:12px;color:var(--dim);margin-top:2px}
  .count-total{font-size:10px;color:rgba(240,236,224,.3);margin-top:4px}
  .tasbih-controls{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:14px}
  .ctrl-btn{width:44px;height:44px;border-radius:50%;border:1px solid rgba(201,168,76,.2);background:rgba(26,107,74,.1);color:var(--gold);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-family:'Noto Sans',sans-serif}
  .ctrl-btn:active{background:rgba(201,168,76,.15);transform:scale(.9)}
  .target-selector{display:flex;gap:6px;margin-top:10px}
  .target-btn{padding:5px 12px;border-radius:16px;font-size:11px;font-weight:600;background:rgba(26,107,74,.1);border:1px solid rgba(201,168,76,.1);color:var(--dim);cursor:pointer;transition:all .2s;user-select:none;font-family:'Noto Sans',sans-serif}
  .target-btn.active{background:rgba(201,168,76,.2);border-color:var(--gold);color:var(--gold-l)}
  .ripple{position:absolute;border-radius:50%;background:rgba(201,168,76,.15);animation:rippleAnim .5s ease-out forwards;pointer-events:none}

  .ld{text-align:center;padding:50px 20px}
  .sp{width:40px;height:40px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px}
  .ld p{font-size:12px;color:var(--dim)} .er{color:#E87C6C}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  @keyframes rippleAnim{0%{transform:scale(0);opacity:1}100%{transform:scale(2.5);opacity:0}}
</style>
</head>
<body>
<div class="tabs">
  <div class="tab active" onclick="switchTab('qibla')">üß≠ <span id="tabQ">–ö–∏–±–ª–∞</span></div>
  <div class="tab" onclick="switchTab('tasbih')">üìø <span id="tabT">–¢–∞—Å–±–∏—Ö</span></div>
</div>
<div class="page active" id="pg-q"><div id="ct"><div class="ld"><div class="sp"></div><p id="lt"></p></div></div></div>
<div class="page" id="pg-t"><div class="tasbih-page" id="tc" style="display:flex;flex-direction:column;align-items:center;flex:1;justify-content:center;width:100%"></div></div>

<script>
/* ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê */
const KAABA={lat:21.422487,lng:39.826206},R=6371;

/* ‚ïê‚ïê‚ïê TELEGRAM ‚ïê‚ïê‚ïê */
(function(){
  try{
    const tg=window.Telegram&&window.Telegram.WebApp;
    if(!tg)return;
    tg.ready();
    tg.expand();
    tg.headerColor='#0B1D15';
    tg.backgroundColor='#0B1D15';
  }catch(e){}
})();

/* ‚ïê‚ïê‚ïê AUTO-REFRESH on re-open (Page Visibility API) ‚ïê‚ïê‚ïê
   –°–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–±: —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
   –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É / –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp —Å–Ω–æ–≤–∞.
   –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –∏ –≤—Å–µ—Ö –≤–µ—Ä—Å–∏—è—Ö Telegram.
*/
(function(){
  let hiddenAt = 0;
  document.addEventListener('visibilitychange', function(){
    if(document.visibilityState === 'hidden'){
      // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –º–æ–º–µ–Ω—Ç —Å–∫—Ä—ã—Ç–∏—è
      hiddenAt = Date.now();
    } else if(document.visibilityState === 'visible'){
      const awayMs = hiddenAt ? Date.now() - hiddenAt : 0;
      if(awayMs > 30000){
        location.reload();
      } else {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä –∏ lastRenderedAngle ‚Äî dial –ø–ª–∞–≤–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ
        if(typeof bufIdx !== 'undefined'){
          bufIdx=0; bufCount=0;
          for(let i=0;i<BUF_SIZE;i++){bufCos[i]=0;bufSin[i]=0;}
          lastRenderedAngle=null;
          lastArrowAngle=null;
        }
      }
    }
  });

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: focus –Ω–∞ –æ–∫–Ω–µ (–¥–µ—Å–∫—Ç–æ–ø / –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ Android)
  window.addEventListener('focus', function(){
    if(typeof bufIdx !== 'undefined'){
      bufIdx=0; bufCount=0;
      for(let i=0;i<BUF_SIZE;i++){bufCos[i]=0;bufSin[i]=0;}
      lastRenderedAngle=null;
      lastArrowAngle=null;
    }
  });
})();
const P=new URLSearchParams(location.search);
const pCity=P.get('city')||'',pLat=parseFloat(P.get('lat')),pLng=parseFloat(P.get('lng')),pLang=P.get('lang')||'ru';

/* ‚ïê‚ïê‚ïê i18n ‚ïê‚ïê‚ïê */
const L={
  ru:{ld:'–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...',qibla:'–ö–∏–±–ª–∞',tasbih:'–¢–∞—Å–±–∏—Ö',dist:'–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ',dir:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
      on:'üß≠ –ö–æ–º–ø–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç',off:'–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ ‚àû',face:'‚úÖ –í—ã —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ —Å—Ç–æ—Ä–æ–Ω—É –∫–∏–±–ª—ã! üïã',km:'–∫–º',
      err:'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',den:'–†–∞–∑—Ä–µ—à–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é',
      reset:'–°–±—Ä–æ—Å',total:'–í—Å–µ–≥–æ',of:'–∏–∑',
      dirs:['–°','–°–°–í','–°–í','–í–°–í','–í','–í–Æ–í','–Æ–í','–Æ–Æ–í','–Æ','–Æ–Æ–ó','–Æ–ó','–ó–Æ–ó','–ó','–ó–°–ó','–°–ó','–°–°–ó']},
  uz:{ld:'Joylashuv aniqlanmoqda...',qibla:'Qibla',tasbih:'Tasbih',dist:'Masofa',dir:'Yo\'nalish',
      on:'üß≠ Kompas ishlayapti',off:'Telefoni kalibrlash uchun aylantiring ‚àû',face:'‚úÖ Siz qibla tomonga qarab turibsiz! üïã',km:'km',
      err:'Joylashuvni aniqlab bo\'lmadi',den:'Geolokatsiyaga ruxsat bering',
      reset:'Qayta',total:'Jami',of:'dan',
      dirs:['Sh','ShShSh','ShSh','ShShSh','Sh','ShJSh','JSh','JJSh','J','JJG','JG','GJG','G','GShG','ShG','ShShG']},
  en:{ld:'Detecting location...',qibla:'Qibla',tasbih:'Tasbih',dist:'Distance',dir:'Direction',
      on:'üß≠ Compass is working',off:'Rotate phone to calibrate ‚àû',face:'‚úÖ You are facing the Qibla! üïã',km:'km',
      err:'Unable to detect location',den:'Allow geolocation',
      reset:'Reset',total:'Total',of:'of',
      dirs:['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW']}
};
const t=L[pLang]||L.ru;
document.getElementById('lt').textContent=t.ld;
document.getElementById('tabQ').textContent=t.qibla;
document.getElementById('tabT').textContent=t.tasbih;

function switchTab(tb){
  document.querySelectorAll('.tab').forEach((e,i)=>e.classList.toggle('active',i===(tb==='qibla'?0:1)));
  document.getElementById('pg-q').classList.toggle('active',tb==='qibla');
  document.getElementById('pg-t').classList.toggle('active',tb==='tasbih');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMPASS ENGINE ‚Äî production grade
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const toRad=d=>d*Math.PI/180,toDeg=r=>r*180/Math.PI;
function qiblaAngle(lat,lng){
  const f=toRad(lat),fK=toRad(KAABA.lat),dL=toRad(KAABA.lng-lng);
  let q=toDeg(Math.atan2(Math.sin(dL),Math.cos(f)*Math.tan(fK)-Math.sin(f)*Math.cos(dL)));
  return q<0?q+360:q;
}
function haversine(lat,lng){
  const f1=toRad(lat),f2=toRad(KAABA.lat),df=toRad(KAABA.lat-lat),dl=toRad(KAABA.lng-lng);
  const a=Math.sin(df/2)**2+Math.cos(f1)*Math.cos(f2)*Math.sin(dl/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function cDir(b){return t.dirs[Math.round(b/22.5)%16]}

/* ‚îÄ‚îÄ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–æ–º–ø–∞—Å ‚îÄ‚îÄ */
let geoConfirmed=false;

/* ‚îÄ‚îÄ Compass state ‚îÄ‚îÄ */
let qAngle=0;
let compassOk=false;
let gotAbsolute=false;
let lastRenderedAngle=null;  // —É–≥–æ–ª —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç–∞
let lastArrowAngle=null;     // —É–≥–æ–ª —Å—Ç—Ä–µ–ª–∫–∏ –∫–∏–±–ª—ã
let renderQueued=false;

/*
 * CIRCULAR BUFFER for heading samples.
 * We store last N headings as unit vectors (cos,sin),
 * then compute circular mean = atan2(avg_sin, avg_cos).
 * This avoids the 359¬∞/1¬∞ wraparound problem entirely.
 */
const BUF_SIZE=20;
const bufCos=new Float64Array(BUF_SIZE);
const bufSin=new Float64Array(BUF_SIZE);
let bufIdx=0, bufCount=0;

function pushHeading(h){
  const r=toRad(h);
  bufCos[bufIdx]=Math.cos(r);
  bufSin[bufIdx]=Math.sin(r);
  bufIdx=(bufIdx+1)%BUF_SIZE;
  if(bufCount<BUF_SIZE)bufCount++;
}

function getSmoothedHeading(){
  // –ñ–¥—ë–º –º–∏–Ω–∏–º—É–º 5 —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—ç–º–ø–ª–æ–≤ ‚Äî –∏–Ω–∞—á–µ –Ω—É–ª–∏ –≤ –±—É—Ñ–µ—Ä–µ —Ç—è–Ω—É—Ç —Å—Ä–µ–¥–Ω–µ–µ –∫ 0
  if(bufCount<5)return null;
  let sc=0,ss=0;
  for(let i=0;i<bufCount;i++){sc+=bufCos[i];ss+=bufSin[i]}
  let avg=toDeg(Math.atan2(ss/bufCount,sc/bufCount));
  return avg<0?avg+360:avg;
}

/* ‚îÄ‚îÄ Sensor event handler ‚îÄ‚îÄ */
function onSensor(e){
  let h=null;

  // iOS: webkitCompassHeading is always absolute
  if(e.webkitCompassHeading!==undefined&&e.webkitCompassHeading!==null){
    h=e.webkitCompassHeading;
  }
  // Android absolute event or absolute flag
  else if(e.absolute===true&&e.alpha!==null){
    h=(360-e.alpha)%360;
  }
  // Fallback: relative alpha (less reliable)
  else if(e.alpha!==null){
    // Only use if we haven't gotten absolute yet
    if(!gotAbsolute) h=(360-e.alpha)%360;
  }

  if(h===null||isNaN(h))return;
  compassOk=true;
  pushHeading(h);
  scheduleRender();
}

function onAbsoluteSensor(e){
  gotAbsolute=true;
  onSensor(e);
}

/* ‚îÄ‚îÄ rAF render loop ‚Äî only ONE DOM update per frame ‚îÄ‚îÄ */
function scheduleRender(){
  if(renderQueued)return;
  renderQueued=true;
  requestAnimationFrame(doRender);
}

function doRender(){
  renderQueued=false;
  // –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–æ–º–ø–∞—Å –µ—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
  if(!geoConfirmed)return;
  const dial=document.getElementById('dial');
  const qarrow=document.getElementById('qarrow');
  if(!dial||!qarrow)return;

  const heading=getSmoothedHeading();
  if(heading===null)return;

  // –¶–∏—Ñ–µ—Ä–±–ª–∞—Ç –≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—Ä–æ—Ç–∏–≤ —Ö–æ–¥–∞ –∫–æ–º–ø–∞—Å–∞ ‚Äî N –≤—Å–µ–≥–¥–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Å–µ–≤–µ—Ä–µ
  const dialTarget=-heading;
  // –°—Ç—Ä–µ–ª–∫–∞ –∫–∏–±–ª—ã –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ú–µ–∫–∫—É
  const arrowTarget=qAngle-heading;

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–∏—Ñ–µ—Ä–±–ª–∞—Ç (—Å dead zone 2¬∞)
  if(lastRenderedAngle!==null){
    let d=((dialTarget-lastRenderedAngle)%360+540)%360-180;
    if(Math.abs(d)<2.0){
      // –ü—Ä–æ–≤–µ—Ä–∏–º —Å—Ç—Ä–µ–ª–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ –¥–∞–∂–µ –µ—Å–ª–∏ –¥–∏—Å–∫ –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è
    } else {
      lastRenderedAngle+=d;
      dial.style.transform=`rotate(${lastRenderedAngle}deg)`;
    }
  }else{
    lastRenderedAngle=dialTarget;
    dial.style.transform=`rotate(${lastRenderedAngle}deg)`;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫—É –∫–∏–±–ª—ã (—Å dead zone 2¬∞)
  if(lastArrowAngle!==null){
    let d=((arrowTarget-lastArrowAngle)%360+540)%360-180;
    if(Math.abs(d)>=2.0){
      lastArrowAngle+=d;
      qarrow.style.transform=`rotate(${lastArrowAngle}deg)`;
    }
  }else{
    lastArrowAngle=arrowTarget;
    qarrow.style.transform=`rotate(${lastArrowAngle}deg)`;
  }

  // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ: —Å—Ç—Ä–µ–ª–∫–∞ —Å–º–æ—Ç—Ä–∏—Ç –≤–≤–µ—Ä—Ö (‚âà0¬∞) ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–∏—Ü–æ–º –∫ –ú–µ–∫–∫–µ
  const normArrow=((lastArrowAngle||0)%360+360)%360;
  const diff=normArrow>180?360-normArrow:normArrow;
  const el=document.getElementById('aligned');
  if(el){
    if(diff<5)el.classList.add('show');
    else el.classList.remove('show');
  }

  const hint=document.getElementById('hint');
  if(hint&&!hint.dataset.on){
    hint.classList.remove('off');
    hint.querySelector('.tx').textContent=t.on;
    hint.dataset.on='1';
  }
}

/* ‚îÄ‚îÄ Start compass listeners with correct priority ‚îÄ‚îÄ */
function startCompass(){
  // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–ø–∞—Å –µ—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
  if(!geoConfirmed){
    console.warn('startCompass: –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞, –∫–æ–º–ø–∞—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω');
    return;
  }
  // PRIORITY 1: deviceorientationabsolute (Chrome Android ‚Äî true north)
  if('ondeviceorientationabsolute' in window||window.DeviceOrientationAbsoluteEvent){
    window.addEventListener('deviceorientationabsolute',onAbsoluteSensor,true);
  }

  // PRIORITY 2: deviceorientation
  if(window.DeviceOrientationEvent){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      // iOS 13+ ‚Äî —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∂–µ—Å—Ç–∞ (tap)
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤–µ—Ä—Ö hint
      const hint=document.getElementById('hint');
      if(hint&&!hint.dataset.iosAsked){
        hint.dataset.iosAsked='1';
        hint.innerHTML=`<button id="ios-perm" style="
          background:rgba(201,168,76,.2);border:1px solid var(--gold);
          color:var(--gold-l);border-radius:20px;padding:6px 18px;
          font-size:12px;font-weight:600;cursor:pointer;font-family:'Noto Sans',sans-serif
        ">üß≠ –†–∞–∑—Ä–µ—à–∏—Ç—å –∫–æ–º–ø–∞—Å</button>`;
        document.getElementById('ios-perm').addEventListener('click',function(){
          DeviceOrientationEvent.requestPermission().then(s=>{
            if(s==='granted'){
              window.addEventListener('deviceorientation',onSensor,true);
              const h=document.getElementById('hint');
              if(h){h.className='hint off';h.innerHTML='<div class="dot"></div><span class="tx">'+t.off+'</span>';}
            }
          }).catch(()=>{});
        },{once:true});
      }
    }else{
      window.addEventListener('deviceorientation',onSensor,true);
    }
  }
}

/* ‚ïê‚ïê‚ïê RENDER QIBLA PAGE ‚ïê‚ïê‚ïê */
function renderQibla(lat,lng,city){
  qAngle=qiblaAngle(lat,lng);
  const d=haversine(lat,lng),dir=cDir(qAngle),S=270,cx=S/2,cy=S/2;

  let ticks='';
  for(let i=0;i<360;i+=5){
    const mj=i%30===0,md=i%15===0,r1=mj?118:(md?122:125),r2=135,a=toRad(i-90);
    ticks+=`<line x1="${cx+r1*Math.cos(a)}" y1="${cy+r1*Math.sin(a)}" x2="${cx+r2*Math.cos(a)}" y2="${cy+r2*Math.sin(a)}" stroke="${mj?'rgba(201,168,76,.6)':'rgba(201,168,76,.15)'}" stroke-width="${mj?1.5:.5}"/>`;
  }
  let cs='';
  [[0,'N','rgba(201,168,76,.85)',15],[90,'E','rgba(201,168,76,.4)',12],[180,'S','rgba(201,168,76,.4)',12],[270,'W','rgba(201,168,76,.4)',12]].forEach(([a,l,c,fs])=>{
    const r=103,ar=toRad(a-90);
    cs+=`<text x="${cx+r*Math.cos(ar)}" y="${cy+r*Math.sin(ar)+4}" text-anchor="middle" fill="${c}" font-family="Amiri,serif" font-size="${fs}" font-weight="700">${l}</text>`;
  });
  [30,60,120,150,210,240,300,330].forEach(dg=>{
    const r=92,ar=toRad(dg-90);
    cs+=`<text x="${cx+r*Math.cos(ar)}" y="${cy+r*Math.sin(ar)+3}" text-anchor="middle" fill="rgba(201,168,76,.2)" font-family="Noto Sans" font-size="7">${dg}¬∞</text>`;
  });

  document.getElementById('ct').innerHTML=`
    <div class="hd"><div class="ar">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê</div><h1>üïã ${t.qibla}</h1>${city?`<div class="city">üìç <b>${decodeURIComponent(city)}</b></div>`:''}</div>
    <div class="deg">${qAngle.toFixed(1)}¬∞<span class="sm">${dir}</span></div>
    <div class="hint off" id="hint"><div class="dot"></div><span class="tx">${t.off}</span></div>
    <div class="cmp"><div class="cmp-bg"></div>
      <div class="dial" id="dial"><svg viewBox="0 0 ${S} ${S}">${ticks}${cs}</svg></div>
      <svg class="arrow" id="qarrow" viewBox="0 0 ${S} ${S}" style="position:absolute;inset:0;z-index:20;pointer-events:none;will-change:transform">
        <defs>
          <linearGradient id="ag" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#E8D48B"/><stop offset="100%" stop-color="#9A7B2E"/></linearGradient>
          <filter id="gw"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <g filter="url(#gw)">
          <polygon points="${cx},20 ${cx-13},${cy-10} ${cx},${cy-24} ${cx+13},${cy-10}" fill="url(#ag)"/>
          <polygon points="${cx},${S-20} ${cx-9},${cy+10} ${cx},${cy+24} ${cx+9},${cy+10}" fill="rgba(201,168,76,.12)"/>
        </g>
        <text x="${cx}" y="13" text-anchor="middle" font-size="19">üïã</text>
        <circle cx="${cx}" cy="${cy}" r="5" fill="#0B1D15" stroke="#C9A84C" stroke-width="2"/>
        <circle cx="${cx}" cy="${cy}" r="2" fill="#C9A84C"/>
      </svg>
    </div>
    <div class="aligned" id="aligned">${t.face}</div>
    <div class="ibar">
      <div class="ib"><div class="l">${t.dir}</div><div class="v">${dir}</div></div>
      <div class="ib"><div class="l">${t.dist}</div><div class="v">${d.toFixed(0)}<span class="u"> ${t.km}</span></div></div>
      <div class="ib"><div class="l">${t.qibla}</div><div class="v">${qAngle.toFixed(1)}¬∞</div></div>
    </div>`;

  lastRenderedAngle=null;
  lastArrowAngle=null;
  // startCompass –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –Ω–µ –∑–¥–µ—Å—å
}

function showErr(m){document.getElementById('ct').innerHTML=`<div class="ld"><p class="er">‚ö†Ô∏è ${m}</p></div>`}

/* ‚ïê‚ïê‚ïê TASBIH ‚ïê‚ïê‚ïê */
const DHIKR=[
  {ar:'ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê',tr:'–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö',truz:'Subhanalloh',tren:'SubhanAllah',mean:'–ü—Ä–µ—á–∏—Å—Ç –ê–ª–ª–∞—Ö',meanuz:'Alloh pok',meanen:'Glory be to Allah',target:33},
  {ar:'Ÿ±ŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸ∞ŸáŸê',tr:'–ê–ª—å—Ö–∞–º–¥—É–ª–∏–ª–ª—è—Ö',truz:'Alhamdulillah',tren:'Alhamdulillah',mean:'–•–≤–∞–ª–∞ –ê–ª–ª–∞—Ö—É',meanuz:'Allohga hamd',meanen:'Praise be to Allah',target:33},
  {ar:'Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè',tr:'–ê–ª–ª–∞—Ö—É –ê–∫–±–∞—Ä',truz:'Allohu Akbar',tren:'Allahu Akbar',mean:'–ê–ª–ª–∞—Ö –í–µ–ª–∏–∫',meanuz:'Alloh Buyuk',meanen:'Allah is the Greatest',target:33},
  {ar:'ŸÑŸéÿß ÿ•ŸêŸÑŸéŸ∞ŸáŸé ÿ•ŸêŸÑŸéŸëÿß Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè',tr:'–õ—è –∏–ª—è—Ö–∞ –∏–ª–ª—è–ª–ª–∞—Ö',truz:'La ilaha illalloh',tren:'La ilaha illAllah',mean:'–ù–µ—Ç –±–æ–≥–∞, –∫—Ä–æ–º–µ –ê–ª–ª–∞—Ö–∞',meanuz:'Allohdan boshqa iloh yo\'q',meanen:'There is no god but Allah',target:100},
  {ar:'ÿ£Ÿéÿ≥Ÿíÿ™Ÿéÿ∫ŸíŸÅŸêÿ±Ÿè Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸé',tr:'–ê—Å—Ç–∞–≥—Ñ–∏—Ä—É–ª–ª–∞—Ö',truz:'Astaghfirulloh',tren:'Astaghfirullah',mean:'–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è —É –ê–ª–ª–∞—Ö–∞',meanuz:'Allohdan mag\'firat so\'rayman',meanen:'I seek forgiveness from Allah',target:100},
  {ar:'ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê ŸàŸéÿ®Ÿêÿ≠ŸéŸÖŸíÿØŸêŸáŸê',tr:'–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö–∏ –≤–∞ –±–∏—Ö–∞–º–¥–∏—Ö',truz:'Subhanallahi va bihamdihi',tren:'SubhanAllahi wa bihamdihi',mean:'–ü—Ä–µ—á–∏—Å—Ç –ê–ª–ª–∞—Ö –∏ —Ö–≤–∞–ª–∞ –ï–º—É',meanuz:'Alloh pok va Unga hamd',meanen:'Glory and praise be to Allah',target:100},
];
let curD=0,cnt=0,totCnt=0,tgt=33;
const CIRC=2*Math.PI*100;
function gTr(d){return pLang==='uz'?d.truz:pLang==='en'?d.tren:d.tr}
function gMn(d){return pLang==='uz'?d.meanuz:pLang==='en'?d.meanen:d.mean}

function renderTasbih(){
  const d=DHIKR[curD];tgt=d.target;
  document.getElementById('tc').innerHTML=`
    <div class="dhikr-selector">${DHIKR.map((dh,i)=>`<div class="dhikr-btn${i===curD?' active':''}" onclick="selD(${i})">${gTr(dh)}</div>`).join('')}</div>
    <div class="tasbih-display">
      <div class="tasbih-arabic">${d.ar}</div>
      <div class="tasbih-translit">${gTr(d)}</div>
      <div class="tasbih-meaning">${gMn(d)}</div>
    </div>
    <div class="counter-wrap" id="cw" onclick="inc(event)">
      <svg class="progress-ring" viewBox="0 0 220 220"><circle class="progress-bg" cx="110" cy="110" r="100"/><circle class="progress-bar" id="pb" cx="110" cy="110" r="100" stroke-dasharray="${CIRC}" stroke-dashoffset="${CIRC}"/></svg>
      <div class="tap-area"><div class="count-num" id="cn">0</div><div class="count-target" id="cgt">0 ${t.of} ${tgt}</div><div class="count-total" id="ctt">${t.total}: 0</div></div>
    </div>
    <div class="tasbih-controls"><div class="ctrl-btn" onclick="rstCnt()">‚Ü∫</div></div>
    <div class="target-selector">${[33,99,100,500,1000].map(n=>`<div class="target-btn${n===tgt?' active':''}" onclick="setTgt(${n})">${n}</div>`).join('')}</div>`;
  updProg();
}
function selD(i){curD=i;cnt=0;renderTasbih()}
function setTgt(n){tgt=n;cnt=0;renderTasbih()}
function inc(ev){
  cnt++;totCnt++;
  try{navigator.vibrate&&navigator.vibrate(15)}catch(e){}
  try{Telegram.WebApp.HapticFeedback.impactOccurred('light')}catch(e){}
  const w=document.getElementById('cw'),rc=w.getBoundingClientRect(),rp=document.createElement('div');
  rp.className='ripple';rp.style.width=rp.style.height='60px';
  rp.style.left=(ev.clientX-rc.left-30)+'px';rp.style.top=(ev.clientY-rc.top-30)+'px';
  w.appendChild(rp);setTimeout(()=>rp.remove(),500);
  if(cnt>=tgt){cnt=0;try{navigator.vibrate&&navigator.vibrate([30,50,30])}catch(e){}try{Telegram.WebApp.HapticFeedback.notificationOccurred('success')}catch(e){}}
  updProg();
}
function rstCnt(){cnt=0;totCnt=0;updProg();try{navigator.vibrate&&navigator.vibrate(10)}catch(e){}}
function updProg(){
  const n=document.getElementById('cn'),g=document.getElementById('cgt'),tt=document.getElementById('ctt'),b=document.getElementById('pb');
  if(!n)return;n.textContent=cnt;g.textContent=`${cnt} ${t.of} ${tgt}`;tt.textContent=`${t.total}: ${totCnt}`;
  b.style.strokeDashoffset=CIRC*(1-cnt/tgt);
}

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
renderTasbih();
(function(){
  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–µ—Ä–µ–¥–∞–Ω—ã —á–µ—Ä–µ–∑ URL
  if(!isNaN(pLat)&&!isNaN(pLng)){
    geoConfirmed=true;
    renderQibla(pLat,pLng,pCity);
    startCompass();
    return;
  }

  let compassStarted=false;
  let watchId=null;

  function onGeoSuccess(lat,lng){
    geoConfirmed=true;
    renderQibla(lat,lng,pCity||'');
    if(!compassStarted){
      compassStarted=true;
      startCompass();
    }
    // watchPosition ‚Äî –æ–¥–∏–Ω —Ä–∞–∑, —Ç–æ–ª—å–∫–æ –Ω–∞—Ç–∏–≤–Ω—ã–π (Telegram LocationManager –Ω–µ –¥–∞—ë—Ç real-time)
    if(watchId===null&&navigator.geolocation){
      watchId=navigator.geolocation.watchPosition(
        function(q){qAngle=qiblaAngle(q.coords.latitude,q.coords.longitude);},
        function(){},
        {enableHighAccuracy:true,timeout:15000,maximumAge:60000}
      );
    }
  }

  function showDenied(){
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    document.getElementById('ct').innerHTML=`
      <div class="ld">
        <p class="er">üìç ${t.den}</p>
        <button onclick="openGeoSettings()" style="
          margin-top:16px;background:rgba(201,168,76,.2);border:1px solid var(--gold);
          color:var(--gold-l);border-radius:20px;padding:8px 22px;
          font-size:13px;font-weight:600;cursor:pointer;font-family:'Noto Sans',sans-serif
        ">‚öôÔ∏è –û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>`;
  }

  window.openGeoSettings=function(){
    const lm=window.Telegram&&window.Telegram.WebApp&&window.Telegram.WebApp.LocationManager;
    if(lm&&lm.isInited) lm.openSettings();
    else if(navigator.permissions&&navigator.permissions.query){
      navigator.permissions.query({name:'geolocation'}).then(function(r){
        if(r.state==='denied') Telegram&&Telegram.WebApp&&Telegram.WebApp.openLink&&
          Telegram.WebApp.openLink('app-settings:');
      });
    }
  };

  function tryNativeGeo(){
    if(!navigator.geolocation){showErr(t.err);return;}
    navigator.geolocation.getCurrentPosition(
      function(p){onGeoSuccess(p.coords.latitude,p.coords.longitude);},
      function(e){
        if(e.code===1) showDenied();
        else if(e.code===3){
          // –¢–∞–π–º–∞—É—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –±–µ–∑ –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
          navigator.geolocation.getCurrentPosition(
            function(p){onGeoSuccess(p.coords.latitude,p.coords.longitude);},
            function(){showErr(t.err);},
            {enableHighAccuracy:false,timeout:10000,maximumAge:30000}
          );
        } else showErr(t.err);
      },
      {enableHighAccuracy:true,timeout:10000,maximumAge:0}
    );
  }

  // Telegram LocationManager (Bot API 8.0+)
  const tg=window.Telegram&&window.Telegram.WebApp;
  const lm=tg&&tg.LocationManager;

  if(lm){
    lm.init(function(){
      if(!lm.isLocationAvailable){
        // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
        tryNativeGeo();
        return;
      }
      if(!lm.isAccessGranted){
        // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –¥–∞–Ω–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–Ω–µ–ª—å–∑—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        showDenied();
        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—ë—Ç—Å—è —Å –Ω–∞—Å—Ç—Ä–æ–µ–∫
        tg.onEvent('locationManagerUpdated',function(){
          if(lm.isAccessGranted){
            lm.getLocation(function(loc){
              if(loc) onGeoSuccess(loc.latitude,loc.longitude);
              else tryNativeGeo();
            });
          }
        });
        return;
      }
      // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –µ—Å—Ç—å ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
      lm.getLocation(function(loc){
        if(loc) onGeoSuccess(loc.latitude,loc.longitude);
        else tryNativeGeo(); // LocationManager –≤–µ—Ä–Ω—É–ª null ‚Äî fallback
      });
    });
  } else {
    // –ù–µ—Ç Telegram LocationManager ‚Äî –Ω–∞—Ç–∏–≤–Ω—ã–π API
    tryNativeGeo();
  }
})();
</script>
</body>
</html>
