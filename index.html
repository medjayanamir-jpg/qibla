<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Qibla</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans:wght@300;400;600;700&display=swap');

  :root {
    --gold: #C9A84C;
    --gold-light: #E8D48B;
    --emerald: #1A6B4A;
    --bg: #0B1D15;
    --text: #F0ECE0;
    --dim: rgba(240,236,224,0.5);
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body { overscroll-behavior:none; }

  body {
    font-family:'Noto Sans',sans-serif;
    background:var(--bg);
    color:var(--text);
    min-height:100dvh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    position:relative;
  }

  body::before {
    content:'';position:fixed;inset:0;
    background:radial-gradient(ellipse 90% 70% at 50% 30%,rgba(26,107,74,0.2) 0%,transparent 70%);
    pointer-events:none;
  }

  .app {
    display:flex;flex-direction:column;align-items:center;
    padding:20px 16px;
    position:relative;z-index:1;
    width:100%;
  }

  /* Header */
  .head { text-align:center; margin-bottom:10px; }
  .head .ar { font-family:'Amiri',serif; font-size:22px; color:var(--gold); }
  .head h1 { font-family:'Amiri',serif; font-size:24px; margin-top:2px; }
  .head .city { font-size:13px; color:var(--dim); margin-top:4px; }
  .head .city b { color:var(--text); }

  /* Degree display */
  .degree-display {
    font-family:'Amiri',serif;
    font-size:48px;
    font-weight:700;
    color:var(--gold-light);
    text-align:center;
    margin:10px 0 6px;
    letter-spacing:1px;
  }
  .degree-display .small { font-size:18px; color:var(--dim); font-weight:400; margin-left:4px; }

  .compass-hint {
    font-size:11px; color:var(--dim); text-align:center; margin-bottom:16px;
    display:flex; align-items:center; gap:5px; justify-content:center;
  }
  .compass-hint .dot {
    width:6px;height:6px;border-radius:50%;
    background:#4CAF50;
    animation:blink 1.5s infinite;
  }
  .compass-hint.off .dot { background:#666; animation:none; }

  /* ‚îÄ‚îÄ‚îÄ COMPASS ‚îÄ‚îÄ‚îÄ */
  .compass-container {
    position:relative;
    width:min(320px,85vw);
    height:min(320px,85vw);
    margin:0 auto;
  }

  .compass-bg {
    position:absolute;inset:0;border-radius:50%;
    background:radial-gradient(circle at 45% 40%,rgba(26,107,74,0.1),rgba(10,26,20,0.95) 70%);
    border:2px solid rgba(201,168,76,0.2);
    box-shadow:0 0 50px rgba(26,107,74,0.15),inset 0 0 40px rgba(0,0,0,0.4);
  }

  /* The whole dial rotates with device heading */
  .compass-dial {
    position:absolute;inset:0;
    transition:transform 0.15s linear;
  }

  .compass-dial svg { width:100%;height:100%; }

  /* Fixed arrow in the center ‚Äî always points UP */
  .arrow-fixed {
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    width:60%;height:60%;
    pointer-events:none;
    z-index:10;
    filter:drop-shadow(0 0 12px rgba(201,168,76,0.5));
  }

  /* Kaaba icon at top */
  .kaaba-top {
    position:absolute;
    top:6%;left:50%;transform:translateX(-50%);
    font-size:28px;z-index:11;
    filter:drop-shadow(0 0 8px rgba(201,168,76,0.4));
  }

  /* Info cards */
  .info-bar {
    display:flex; gap:12px; margin-top:20px; width:100%; max-width:340px;
  }
  .info-box {
    flex:1;
    background:rgba(26,107,74,0.1);
    border:1px solid rgba(201,168,76,0.12);
    border-radius:12px;
    padding:10px 12px;
    text-align:center;
    backdrop-filter:blur(8px);
  }
  .info-box .lbl { font-size:9px; text-transform:uppercase; letter-spacing:1.2px; color:var(--dim); font-weight:600; }
  .info-box .val { font-family:'Amiri',serif; font-size:20px; color:var(--gold-light); font-weight:700; margin-top:2px; }
  .info-box .val .u { font-size:11px; color:var(--dim); font-weight:400; }

  .footer {
    margin-top:20px;text-align:center;font-size:10px;color:rgba(240,236,224,0.2);line-height:1.5;
  }

  /* Loading */
  .loading { text-align:center;padding:60px 20px; }
  .spinner {
    width:44px;height:44px;border:3px solid rgba(201,168,76,0.2);
    border-top-color:var(--gold);border-radius:50%;
    animation:spin .8s linear infinite;margin:0 auto 14px;
  }
  .loading p { font-size:13px;color:var(--dim); }
  .err { color:#E87C6C; }

  @keyframes spin { to{transform:rotate(360deg)} }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
</style>
</head>
<body>

<div class="app" id="app">
  <div id="content">
    <div class="loading"><div class="spinner"></div><p id="loadTxt">–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...</p></div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê */
const KAABA = { lat:21.4224779, lng:39.8261818 };
const R = 6371;

/* ‚ïê‚ïê‚ïê TELEGRAM ‚ïê‚ïê‚ïê */
let tg = null;
try {
  tg = window.Telegram && window.Telegram.WebApp;
  if(tg){ tg.ready(); tg.expand(); tg.headerColor='#0B1D15'; tg.backgroundColor='#0B1D15'; }
} catch(e){}

const P = new URLSearchParams(location.search);
const pCity = P.get('city')||'';
const pLat = parseFloat(P.get('lat'));
const pLng = parseFloat(P.get('lng'));
const pLang = P.get('lang')||'ru';

/* ‚ïê‚ïê‚ïê TRANSLATIONS ‚ïê‚ïê‚ïê */
const L = {
  ru:{ load:'–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...', qibla:'–ö–∏–±–ª–∞', dist:'–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ', dir:'–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
       compassOn:'–ö–æ–º–ø–∞—Å –∞–∫—Ç–∏–≤–µ–Ω', compassOff:'–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏',
       fromN:'–æ—Ç —Å–µ–≤–µ—Ä–∞', km:'–∫–º', geoErr:'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ',
       geoDen:'–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏',
       dirs:['–°','–°–°–í','–°–í','–í–°–í','–í','–í–Æ–í','–Æ–í','–Æ–Æ–í','–Æ','–Æ–Æ–ó','–Æ–ó','–ó–Æ–ó','–ó','–ó–°–ó','–°–ó','–°–°–ó'] },
  uz:{ load:'Joylashuv aniqlanmoqda...', qibla:'Qibla', dist:'Masofa', dir:'Yo\'nalish',
       compassOn:'Kompas faol', compassOff:'Telefonni aylantiring',
       fromN:'shimoldan', km:'km', geoErr:'Joylashuvni aniqlab bo\'lmadi',
       geoDen:'Geolokatsiyaga ruxsat bering',
       dirs:['Sh','ShShSh','ShSh','ShShSh','Sh','ShJSh','JSh','JJSh','J','JJG','JG','GJG','G','GShG','ShG','ShShG'] },
  en:{ load:'Detecting location...', qibla:'Qibla', dist:'Distance', dir:'Direction',
       compassOn:'Compass active', compassOff:'Rotate phone to calibrate',
       fromN:'from north', km:'km', geoErr:'Unable to detect location',
       geoDen:'Allow geolocation access',
       dirs:['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'] }
};
const t = L[pLang]||L.ru;
document.getElementById('loadTxt').textContent = t.load;

/* ‚ïê‚ïê‚ïê MATH ‚ïê‚ïê‚ïê */
const rad = d=>d*Math.PI/180, deg = r=>r*180/Math.PI;

function qiblaAngle(lat,lng){
  const œÜ=rad(lat), œÜK=rad(KAABA.lat), ŒîL=rad(KAABA.lng-lng);
  let q = deg(Math.atan2(Math.sin(ŒîL), Math.cos(œÜ)*Math.tan(œÜK)-Math.sin(œÜ)*Math.cos(ŒîL)));
  return q<0?q+360:q;
}

function dist(lat,lng){
  const œÜ1=rad(lat),œÜ2=rad(KAABA.lat),ŒîœÜ=rad(KAABA.lat-lat),ŒîŒª=rad(KAABA.lng-lng);
  const a=Math.sin(ŒîœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function compassDir(b){ return t.dirs[Math.round(b/22.5)%16]; }

/* ‚ïê‚ïê‚ïê COMPASS STATE ‚ïê‚ïê‚ïê */
let heading = 0;
let qAngle = 0;
let compassOk = false;

function startCompass(){
  if(window.DeviceOrientationEvent){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(s=>{
        if(s==='granted') window.addEventListener('deviceorientation',onOri,true);
      }).catch(()=>{});
    } else {
      window.addEventListener('deviceorientation',onOri,true);
    }
  }
}

function onOri(e){
  let h = null;
  if(e.webkitCompassHeading!==undefined) h=e.webkitCompassHeading;
  else if(e.alpha!==null) h=360-e.alpha;
  if(h!==null){
    heading=h; compassOk=true;
    // Rotate the dial so the arrow (fixed pointing UP) points to Qibla
    const rot = -(heading - qAngle);
    const dial = document.getElementById('dial');
    if(dial) dial.style.transform = `rotate(${rot}deg)`;

    const hint = document.getElementById('compassHint');
    if(hint && compassOk){
      hint.classList.remove('off');
      hint.querySelector('.txt').textContent = t.compassOn;
    }
  }
}

/* ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê */
function render(lat,lng,city){
  qAngle = qiblaAngle(lat,lng);
  const d = dist(lat,lng);
  const cDir = compassDir(qAngle);
  const sz = 320;
  const cx=sz/2, cy=sz/2;

  // Tick marks
  let ticks='';
  for(let i=0;i<360;i+=5){
    const major=i%30===0, mid=i%15===0;
    const r1=major?130:(mid?135:138), r2=145;
    const a=rad(i-90);
    ticks+=`<line x1="${cx+r1*Math.cos(a)}" y1="${cy+r1*Math.sin(a)}" x2="${cx+r2*Math.cos(a)}" y2="${cy+r2*Math.sin(a)}" stroke="${major?'rgba(201,168,76,.6)':'rgba(201,168,76,.15)'}" stroke-width="${major?1.5:.5}"/>`;
  }

  // Cardinal labels
  const cards = [
    [0,'N',.7],[90,'E',.4],[180,'S',.4],[270,'W',.4]
  ];
  let cardSvg='';
  cards.forEach(([a,l,op])=>{
    const r=115, ar=rad(a-90);
    cardSvg+=`<text x="${cx+r*Math.cos(ar)}" y="${cy+r*Math.sin(ar)+5}" text-anchor="middle" fill="rgba(201,168,76,${op})" font-family="Amiri,serif" font-size="15" font-weight="700">${l}</text>`;
  });

  document.getElementById('content').innerHTML = `
    <div class="head">
      <div class="ar">ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê</div>
      <h1>üïã ${t.qibla}</h1>
      ${city?`<div class="city">üìç <b>${city}</b></div>`:''}
    </div>

    <div class="degree-display">${qAngle.toFixed(1)}¬∞<span class="small">${cDir}</span></div>

    <div class="compass-hint off" id="compassHint">
      <div class="dot"></div>
      <span class="txt">${t.compassOff}</span>
    </div>

    <div class="compass-container">
      <div class="compass-bg"></div>

      <div class="kaaba-top">üïã</div>

      <!-- Fixed arrow (always points UP = toward Qibla when dial rotates) -->
      <svg class="arrow-fixed" viewBox="0 0 200 200">
        <defs>
          <linearGradient id="ag" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#E8D48B"/>
            <stop offset="100%" stop-color="#9A7B2E"/>
          </linearGradient>
          <filter id="gw">
            <feGaussianBlur stdDeviation="2" result="b"/>
            <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <!-- Arrow pointing UP -->
        <g filter="url(#gw)">
          <polygon points="100,15 88,100 100,90 112,100" fill="url(#ag)"/>
          <polygon points="100,185 88,100 100,110 112,100" fill="rgba(201,168,76,0.2)"/>
        </g>
        <!-- Center circle -->
        <circle cx="100" cy="100" r="6" fill="#0B1D15" stroke="#C9A84C" stroke-width="2"/>
        <circle cx="100" cy="100" r="2" fill="#C9A84C"/>
      </svg>

      <!-- Rotating dial (spins with device compass) -->
      <div class="compass-dial" id="dial" style="transform:rotate(${-qAngle}deg)">
        <svg viewBox="0 0 ${sz} ${sz}">
          ${ticks}
          ${cardSvg}
        </svg>
      </div>
    </div>

    <div class="info-bar">
      <div class="info-box">
        <div class="lbl">${t.dir}</div>
        <div class="val">${cDir}</div>
      </div>
      <div class="info-box">
        <div class="lbl">${t.dist}</div>
        <div class="val">${d.toFixed(0)}<span class="u"> ${t.km}</span></div>
      </div>
      <div class="info-box">
        <div class="lbl">${t.qibla}</div>
        <div class="val">${qAngle.toFixed(1)}¬∞</div>
      </div>
    </div>

    <div class="footer">
      q = atan2(sin ŒîL, cos œÜ ¬∑ tan œÜK ‚àí sin œÜ ¬∑ cos ŒîL)<br>
      Kaaba: 21.4225¬∞N, 39.8262¬∞E
    </div>
  `;

  startCompass();
}

function showErr(m){
  document.getElementById('content').innerHTML=`<div class="loading"><p class="err">‚ö†Ô∏è ${m}</p></div>`;
}

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
(function(){
  if(!isNaN(pLat)&&!isNaN(pLng)){ render(pLat,pLng,pCity); return; }
  if(!navigator.geolocation){ showErr(t.geoErr); return; }
  navigator.geolocation.getCurrentPosition(
    p=>render(p.coords.latitude,p.coords.longitude,pCity||''),
    e=>showErr(e.code===1?t.geoDen:t.geoErr),
    {enableHighAccuracy:true,timeout:8000,maximumAge:60000}
  );
})();
</script>
</body>
</html>
