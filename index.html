<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Qibla</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans:wght@300;400;600;700&display=swap');

  :root {
    --gold:#C9A84C; --gold-l:#E8D48B; --gold-d:#9A7B2E;
    --bg:#0B1D15; --text:#F0ECE0; --dim:rgba(240,236,224,.5);
  }
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{overscroll-behavior:none;overflow:hidden}
  body{
    font-family:'Noto Sans',sans-serif;background:var(--bg);color:var(--text);
    height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;
  }
  body::before{
    content:'';position:fixed;inset:0;
    background:radial-gradient(ellipse 90% 70% at 50% 25%,rgba(26,107,74,.2) 0%,transparent 70%);
    pointer-events:none;
  }

  .app{display:flex;flex-direction:column;align-items:center;padding:16px;position:relative;z-index:1;width:100%}

  /* Header */
  .hd{text-align:center;margin-bottom:8px}
  .hd .ar{font-family:'Amiri',serif;font-size:22px;color:var(--gold)}
  .hd h1{font-family:'Amiri',serif;font-size:22px;margin-top:2px}
  .hd .city{font-size:12px;color:var(--dim);margin-top:3px}
  .hd .city b{color:var(--text)}

  /* Degree */
  .deg{font-family:'Amiri',serif;font-size:52px;font-weight:700;color:var(--gold-l);text-align:center;margin:8px 0 4px}
  .deg .sm{font-size:18px;color:var(--dim);font-weight:400;margin-left:4px}

  /* Hint */
  .hint{font-size:11px;color:var(--dim);text-align:center;margin-bottom:12px;display:flex;align-items:center;gap:5px;justify-content:center}
  .hint .dot{width:6px;height:6px;border-radius:50%;background:#4CAF50;animation:blink 1.5s infinite}
  .hint.off .dot{background:#666;animation:none}

  /* â•â•â• COMPASS â•â•â• */
  .cmp{
    position:relative;
    width:min(300px,82vw);height:min(300px,82vw);
    margin:0 auto;
  }
  .cmp-bg{
    position:absolute;inset:0;border-radius:50%;
    background:radial-gradient(circle at 45% 40%,rgba(26,107,74,.08),rgba(10,26,20,.95) 70%);
    border:2px solid rgba(201,168,76,.2);
    box-shadow:0 0 50px rgba(26,107,74,.12),inset 0 0 40px rgba(0,0,0,.4);
  }

  /* FIXED ARROW â€” z-index above dial, no rotation */
  .arrow{
    position:absolute;inset:0;z-index:20;pointer-events:none;
  }

  /* ROTATING DIAL â€” spins with device compass */
  .dial{
    position:absolute;inset:0;z-index:10;
    transition:transform .12s linear;
  }
  .dial svg{width:100%;height:100%}

  /* Info bar */
  .ibar{display:flex;gap:10px;margin-top:16px;width:100%;max-width:330px}
  .ib{
    flex:1;background:rgba(26,107,74,.1);border:1px solid rgba(201,168,76,.1);
    border-radius:12px;padding:9px 10px;text-align:center;backdrop-filter:blur(6px);
  }
  .ib .l{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);font-weight:600}
  .ib .v{font-family:'Amiri',serif;font-size:19px;color:var(--gold-l);font-weight:700;margin-top:2px}
  .ib .v .u{font-size:11px;color:var(--dim);font-weight:400}

  /* Aligned indicator */
  .aligned{
    font-size:13px;text-align:center;margin-top:10px;
    color:#4CAF50;font-weight:600;
    opacity:0;transition:opacity .3s;
  }
  .aligned.show{opacity:1;animation:pulse 1s infinite}

  .ft{margin-top:14px;text-align:center;font-size:9px;color:rgba(240,236,224,.18);line-height:1.4}

  /* Loading */
  .ld{text-align:center;padding:60px 20px}
  .sp{width:44px;height:44px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 14px}
  .ld p{font-size:13px;color:var(--dim)} .er{color:#E87C6C}

  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
</style>
</head>
<body>
<div class="app" id="app">
  <div id="ct">
    <div class="ld"><div class="sp"></div><p id="lt">ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ...</p></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONFIG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const KAABA={lat:21.4224779,lng:39.8261818};
const R=6371;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TELEGRAM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
try{const tg=window.Telegram&&window.Telegram.WebApp;if(tg){tg.ready();tg.expand();tg.headerColor='#0B1D15';tg.backgroundColor='#0B1D15'}}catch(e){}

const P=new URLSearchParams(location.search);
const pCity=P.get('city')||'', pLat=parseFloat(P.get('lat')), pLng=parseFloat(P.get('lng')), pLang=P.get('lang')||'ru';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• i18n â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const L={
  ru:{ld:'ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ...',qibla:'ĞšĞ¸Ğ±Ğ»Ğ°',dist:'Ğ Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ',dir:'ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ',
      on:'ĞšĞ¾Ğ¼Ğ¿Ğ°Ñ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Â· Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½Ğ¸Ñ‚Ğµ Ğº ĞšĞ¸Ğ±Ğ»Ğµ',off:'Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ñ â€” Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½Ğ¸Ñ‚Ğµ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ âˆ',
      face:'âœ… Ğ’Ñ‹ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğº ĞšĞ¸Ğ±Ğ»Ğµ!',fromN:'Ğ¾Ñ‚ ÑĞµĞ²ĞµÑ€Ğ°',km:'ĞºĞ¼',
      err:'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ',den:'Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸',
      dirs:['Ğ¡','Ğ¡Ğ¡Ğ’','Ğ¡Ğ’','Ğ’Ğ¡Ğ’','Ğ’','Ğ’Ğ®Ğ’','Ğ®Ğ’','Ğ®Ğ®Ğ’','Ğ®','Ğ®Ğ®Ğ—','Ğ®Ğ—','Ğ—Ğ®Ğ—','Ğ—','Ğ—Ğ¡Ğ—','Ğ¡Ğ—','Ğ¡Ğ¡Ğ—']},
  uz:{ld:'Joylashuv aniqlanmoqda...',qibla:'Qibla',dist:'Masofa',dir:'Yo\'nalish',
      on:'Kompas faol Â· Qiblaga qarating',off:'Kompasni yoqing â€” telefonni âˆ aylantiring',
      face:'âœ… Siz Qiblaga qarab turibsiz!',fromN:'shimoldan',km:'km',
      err:'Joylashuvni aniqlab bo\'lmadi',den:'Geolokatsiyaga ruxsat bering',
      dirs:['Sh','ShShSh','ShSh','ShShSh','Sh','ShJSh','JSh','JJSh','J','JJG','JG','GJG','G','GShG','ShG','ShShG']},
  en:{ld:'Detecting location...',qibla:'Qibla',dist:'Distance',dir:'Direction',
      on:'Compass active Â· turn toward Qibla',off:'Enable compass â€” move phone in âˆ',
      face:'âœ… You are facing Qibla!',fromN:'from north',km:'km',
      err:'Unable to detect location',den:'Allow geolocation access',
      dirs:['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW']}
};
const t=L[pLang]||L.ru;
document.getElementById('lt').textContent=t.ld;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;

function qiblaAngle(lat,lng){
  const f=toRad(lat),fK=toRad(KAABA.lat),dL=toRad(KAABA.lng-lng);
  let q=toDeg(Math.atan2(Math.sin(dL),Math.cos(f)*Math.tan(fK)-Math.sin(f)*Math.cos(dL)));
  return q<0?q+360:q;
}
function haversine(lat,lng){
  const f1=toRad(lat),f2=toRad(KAABA.lat),df=toRad(KAABA.lat-lat),dl=toRad(KAABA.lng-lng);
  const a=Math.sin(df/2)**2+Math.cos(f1)*Math.cos(f2)*Math.sin(dl/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function cDir(b){return t.dirs[Math.round(b/22.5)%16]}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let qAngle=0, heading=0, compassOk=false;

/*
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *  KEY ROTATION LOGIC â€” THIS IS THE FIX
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 *  ARROW  = FIXED, always points UP on screen
 *  DIAL   = ROTATES with formula:
 *
 *     dialRotation = qiblaAngle âˆ’ deviceHeading
 *
 *  - deviceHeading = where the phone's top is pointing
 *    (0Â°=North, 90Â°=East, etc.)
 *  - qiblaAngle = bearing from your location to Kaaba
 *
 *  When user turns phone so that top of phone faces Qibla:
 *    deviceHeading â‰ˆ qiblaAngle
 *    dialRotation â‰ˆ 0Â°
 *    "N" on dial aligns to top â†’ arrow points at Qibla âœ…
 *
 *  Without compass data, dial shows static offset = qiblaAngle
 *  (N at top means "if you face North, turn qiblaAngleÂ° clockwise")
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

function updateDial(){
  const dial=document.getElementById('dial');
  if(!dial)return;

  const rotation = qAngle - heading;
  dial.style.transform = `rotate(${rotation}deg)`;

  // Detect alignment: user faces Qibla within Â±5Â°
  const diff = Math.abs(((heading - qAngle) % 360 + 540) % 360 - 180);
  const el = document.getElementById('aligned');
  if(el){
    if(diff < 5) el.classList.add('show');
    else el.classList.remove('show');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DEVICE COMPASS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startCompass(){
  if(!window.DeviceOrientationEvent)return;
  if(typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(s=>{
      if(s==='granted')window.addEventListener('deviceorientation',onOri,true);
    }).catch(()=>{});
  }else{
    window.addEventListener('deviceorientation',onOri,true);
  }
}

function onOri(e){
  let h=null;
  if(e.webkitCompassHeading!==undefined) h=e.webkitCompassHeading;   // iOS
  else if(e.alpha!==null) h=(360-e.alpha)%360;                        // Android
  if(h===null)return;

  heading=h;
  compassOk=true;
  updateDial();

  const hint=document.getElementById('hint');
  if(hint&&!hint.dataset.on){
    hint.classList.remove('off');
    hint.querySelector('.tx').textContent=t.on;
    hint.dataset.on='1';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RENDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(lat,lng,city){
  qAngle=qiblaAngle(lat,lng);
  const d=haversine(lat,lng);
  const dir=cDir(qAngle);
  const S=300,cx=S/2,cy=S/2;

  // Tick marks
  let ticks='';
  for(let i=0;i<360;i+=5){
    const major=i%30===0,mid=i%15===0;
    const r1=major?125:(mid?130:133),r2=142;
    const a=toRad(i-90);
    ticks+=`<line x1="${cx+r1*Math.cos(a)}" y1="${cy+r1*Math.sin(a)}" x2="${cx+r2*Math.cos(a)}" y2="${cy+r2*Math.sin(a)}" stroke="${major?'rgba(201,168,76,.6)':'rgba(201,168,76,.15)'}" stroke-width="${major?1.5:.5}"/>`;
  }

  // Cardinal labels
  let cSvg='';
  [[0,'N','rgba(201,168,76,.85)',16],[90,'E','rgba(201,168,76,.4)',13],[180,'S','rgba(201,168,76,.4)',13],[270,'W','rgba(201,168,76,.4)',13]].forEach(([a,l,c,fs])=>{
    const r=110,ar=toRad(a-90);
    cSvg+=`<text x="${cx+r*Math.cos(ar)}" y="${cy+r*Math.sin(ar)+5}" text-anchor="middle" fill="${c}" font-family="Amiri,serif" font-size="${fs}" font-weight="700">${l}</text>`;
  });

  // Degree labels
  [30,60,120,150,210,240,300,330].forEach(d=>{
    const r=98,ar=toRad(d-90);
    cSvg+=`<text x="${cx+r*Math.cos(ar)}" y="${cy+r*Math.sin(ar)+3}" text-anchor="middle" fill="rgba(201,168,76,.2)" font-family="Noto Sans" font-size="8">${d}Â°</text>`;
  });

  document.getElementById('ct').innerHTML=`
    <div class="hd">
      <div class="ar">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù</div>
      <h1>ğŸ•‹ ${t.qibla}</h1>
      ${city?`<div class="city">ğŸ“ <b>${decodeURIComponent(city)}</b></div>`:''}
    </div>

    <div class="deg">${qAngle.toFixed(1)}Â°<span class="sm">${dir}</span></div>

    <div class="hint off" id="hint">
      <div class="dot"></div>
      <span class="tx">${t.off}</span>
    </div>

    <div class="cmp">
      <div class="cmp-bg"></div>

      <!-- â˜… FIXED ARROW â€” never moves, always points UP â˜… -->
      <svg class="arrow" viewBox="0 0 ${S} ${S}">
        <defs>
          <linearGradient id="ag" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#E8D48B"/>
            <stop offset="100%" stop-color="#9A7B2E"/>
          </linearGradient>
          <filter id="gw">
            <feGaussianBlur stdDeviation="3" result="b"/>
            <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <g filter="url(#gw)">
          <!-- Arrow head pointing UP -->
          <polygon points="${cx},22 ${cx-15},${cy-12} ${cx},${cy-28} ${cx+15},${cy-12}" fill="url(#ag)"/>
          <!-- Arrow tail -->
          <polygon points="${cx},${S-22} ${cx-11},${cy+12} ${cx},${cy+28} ${cx+11},${cy+12}" fill="rgba(201,168,76,.12)"/>
        </g>
        <!-- Kaaba icon at arrow tip -->
        <text x="${cx}" y="16" text-anchor="middle" font-size="22">ğŸ•‹</text>
        <!-- Center dot -->
        <circle cx="${cx}" cy="${cy}" r="6" fill="#0B1D15" stroke="#C9A84C" stroke-width="2"/>
        <circle cx="${cx}" cy="${cy}" r="2.2" fill="#C9A84C"/>
      </svg>

      <!-- â˜… ROTATING DIAL â€” rotates by (qiblaAngle - heading) â˜… -->
      <div class="dial" id="dial" style="transform:rotate(${qAngle}deg)">
        <svg viewBox="0 0 ${S} ${S}">
          ${ticks}
          ${cSvg}
        </svg>
      </div>
    </div>

    <div class="aligned" id="aligned">${t.face}</div>

    <div class="ibar">
      <div class="ib"><div class="l">${t.dir}</div><div class="v">${dir}</div></div>
      <div class="ib"><div class="l">${t.dist}</div><div class="v">${d.toFixed(0)}<span class="u"> ${t.km}</span></div></div>
      <div class="ib"><div class="l">${t.qibla}</div><div class="v">${qAngle.toFixed(1)}Â°</div></div>
    </div>

    <div class="ft">
      q = atan2(sin Î”L, cos Ï† Â· tan Ï†<sub>K</sub> âˆ’ sin Ï† Â· cos Î”L)<br>
      Kaaba: 21.4225Â°N, 39.8262Â°E
    </div>
  `;

  startCompass();
}

function showErr(m){document.getElementById('ct').innerHTML=`<div class="ld"><p class="er">âš ï¸ ${m}</p></div>`}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function(){
  if(!isNaN(pLat)&&!isNaN(pLng)){render(pLat,pLng,pCity);return}
  if(!navigator.geolocation){showErr(t.err);return}
  navigator.geolocation.getCurrentPosition(
    p=>render(p.coords.latitude,p.coords.longitude,pCity||''),
    e=>showErr(e.code===1?t.den:t.err),
    {enableHighAccuracy:true,timeout:8000,maximumAge:60000}
  );
})();
</script>
</body>
</html>
