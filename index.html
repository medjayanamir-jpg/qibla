<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Qibla & Tasbih</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans:wght@300;400;600;700&display=swap');
  :root{--gold:#C9A84C;--gold-l:#E8D48B;--gold-d:#9A7B2E;--bg:#0B1D15;--text:#F0ECE0;--dim:rgba(240,236,224,.5)}
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{overscroll-behavior:none;overflow:hidden}
  body{font-family:'Noto Sans',sans-serif;background:var(--bg);color:var(--text);height:100dvh;display:flex;flex-direction:column}
  body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 90% 70% at 50% 25%,rgba(26,107,74,.2) 0%,transparent 70%);pointer-events:none}

  .tabs{display:flex;width:100%;max-width:400px;margin:0 auto;position:relative;z-index:30;padding:8px 16px 0;flex-shrink:0}
  .tab{flex:1;text-align:center;padding:10px 0 8px;font-size:14px;font-weight:600;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;transition:all .25s;user-select:none}
  .tab.active{color:var(--gold-l);border-bottom-color:var(--gold)} .tab:active{opacity:.7}

  .page{display:none;flex:1;flex-direction:column;align-items:center;overflow-y:auto;overflow-x:hidden;position:relative;z-index:1;padding:12px 16px 24px}
  .page.active{display:flex}

  .hd{text-align:center;margin-bottom:6px}
  .hd .ar{font-family:'Amiri',serif;font-size:20px;color:var(--gold)}
  .hd h1{font-family:'Amiri',serif;font-size:20px;margin-top:1px}
  .hd .city{font-size:11px;color:var(--dim);margin-top:2px} .hd .city b{color:var(--text)}
  .deg{font-family:'Amiri',serif;font-size:46px;font-weight:700;color:var(--gold-l);text-align:center;margin:4px 0 2px}
  .deg .sm{font-size:16px;color:var(--dim);font-weight:400;margin-left:4px}
  .hint{font-size:10px;color:var(--dim);text-align:center;margin-bottom:10px;display:flex;align-items:center;gap:5px;justify-content:center}
  .hint .dot{width:5px;height:5px;border-radius:50%;background:#4CAF50;animation:blink 1.5s infinite}
  .hint.off .dot{background:#666;animation:none}
  .cmp{position:relative;width:min(270px,74vw);height:min(270px,74vw);margin:0 auto}
  .cmp-bg{position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle at 45% 40%,rgba(26,107,74,.08),rgba(10,26,20,.95) 70%);border:2px solid rgba(201,168,76,.2);box-shadow:0 0 40px rgba(26,107,74,.1),inset 0 0 30px rgba(0,0,0,.4)}
  .arrow{position:absolute;inset:0;z-index:20;pointer-events:none}
  .dial{position:absolute;inset:0;z-index:10;will-change:transform} .dial svg{width:100%;height:100%}
  .ibar{display:flex;gap:8px;margin-top:12px;width:100%;max-width:320px}
  .ib{flex:1;background:rgba(26,107,74,.1);border:1px solid rgba(201,168,76,.1);border-radius:10px;padding:7px 8px;text-align:center}
  .ib .l{font-size:8px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);font-weight:600}
  .ib .v{font-family:'Amiri',serif;font-size:17px;color:var(--gold-l);font-weight:700;margin-top:1px}
  .ib .v .u{font-size:10px;color:var(--dim);font-weight:400}
  .aligned{
    font-size:18px;text-align:center;margin-top:10px;
    color:#4ddb8a;font-weight:700;opacity:0;
    transition:opacity .4s;letter-spacing:.02em;
    text-shadow:0 0 12px rgba(77,219,138,.7),0 0 28px rgba(77,219,138,.4);
    filter:drop-shadow(0 0 6px rgba(77,219,138,.6))
  }
  .aligned.show{opacity:1;animation:glowPulse 1.4s ease-in-out infinite}
  @keyframes glowPulse{
    0%,100%{text-shadow:0 0 12px rgba(77,219,138,.7),0 0 28px rgba(77,219,138,.4);transform:scale(1)}
    50%{text-shadow:0 0 22px rgba(77,219,138,1),0 0 50px rgba(77,219,138,.7),0 0 80px rgba(77,219,138,.3);transform:scale(1.04)}
  }

  /* TASBIH */
  .tasbih-page{justify-content:center;gap:0}
  .dhikr-selector{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:16px;max-width:340px}
  .dhikr-btn{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;background:rgba(26,107,74,.15);border:1px solid rgba(201,168,76,.15);color:var(--dim);cursor:pointer;transition:all .2s;user-select:none;font-family:'Noto Sans',sans-serif}
  .dhikr-btn.active{background:rgba(201,168,76,.2);border-color:var(--gold);color:var(--gold-l)} .dhikr-btn:active{transform:scale(.95)}
  .tasbih-display{text-align:center;margin-bottom:8px}
  .tasbih-arabic{font-family:'Amiri',serif;font-size:28px;color:var(--gold);margin-bottom:2px;min-height:38px}
  .tasbih-translit{font-size:12px;color:var(--dim);min-height:18px}
  .tasbih-meaning{font-size:10px;color:rgba(240,236,224,.35);margin-top:2px;min-height:16px}
  .counter-wrap{position:relative;width:220px;height:220px;margin:12px auto;cursor:pointer;user-select:none;-webkit-user-select:none}
  .counter-wrap:active .tap-area{transform:scale(.97)}
  .progress-ring{position:absolute;inset:0;transform:rotate(-90deg)}
  .progress-bg{fill:none;stroke:rgba(201,168,76,.1);stroke-width:6}
  .progress-bar{fill:none;stroke:var(--gold);stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset .15s ease}
  .tap-area{position:absolute;inset:12px;border-radius:50%;background:radial-gradient(circle at 45% 40%,rgba(26,107,74,.15),rgba(10,26,20,.9));border:2px solid rgba(201,168,76,.2);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:transform .1s;box-shadow:0 0 30px rgba(26,107,74,.1),inset 0 0 20px rgba(0,0,0,.3)}
  .count-num{font-family:'Amiri',serif;font-size:64px;font-weight:700;color:var(--gold-l);line-height:1}
  .count-target{font-size:12px;color:var(--dim);margin-top:2px}
  .count-total{font-size:10px;color:rgba(240,236,224,.3);margin-top:4px}
  .tasbih-controls{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:14px}
  .ctrl-btn{width:44px;height:44px;border-radius:50%;border:1px solid rgba(201,168,76,.2);background:rgba(26,107,74,.1);color:var(--gold);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-family:'Noto Sans',sans-serif}
  .ctrl-btn:active{background:rgba(201,168,76,.15);transform:scale(.9)}
  .target-selector{display:flex;gap:6px;margin-top:10px}
  .target-btn{padding:5px 12px;border-radius:16px;font-size:11px;font-weight:600;background:rgba(26,107,74,.1);border:1px solid rgba(201,168,76,.1);color:var(--dim);cursor:pointer;transition:all .2s;user-select:none;font-family:'Noto Sans',sans-serif}
  .target-btn.active{background:rgba(201,168,76,.2);border-color:var(--gold);color:var(--gold-l)}
  .ripple{position:absolute;border-radius:50%;background:rgba(201,168,76,.15);animation:rippleAnim .5s ease-out forwards;pointer-events:none}

  .ld{text-align:center;padding:50px 20px}
  .sp{width:40px;height:40px;border:3px solid rgba(201,168,76,.2);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px}
  .ld p{font-size:12px;color:var(--dim)} .er{color:#E87C6C}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  @keyframes rippleAnim{0%{transform:scale(0);opacity:1}100%{transform:scale(2.5);opacity:0}}
</style>
</head>
<body>
<div class="tabs">
  <div class="tab active" onclick="switchTab('qibla')">ğŸ§­ <span id="tabQ">ĞšĞ¸Ğ±Ğ»Ğ°</span></div>
  <div class="tab" onclick="switchTab('tasbih')">ğŸ“¿ <span id="tabT">Ğ¢Ğ°ÑĞ±Ğ¸Ñ…</span></div>
</div>
<div class="page active" id="pg-q"><div id="ct"><div class="ld"><div class="sp"></div><p id="lt"></p></div></div></div>
<div class="page" id="pg-t"><div class="tasbih-page" id="tc" style="display:flex;flex-direction:column;align-items:center;flex:1;justify-content:center;width:100%"></div></div>

<script>
/* â•â•â• CONSTANTS â•â•â• */
const KAABA={lat:21.422487,lng:39.826206},R=6371;

/* â•â•â• TELEGRAM â•â•â• */
(function(){
  try{
    const tg=window.Telegram&&window.Telegram.WebApp;
    if(!tg)return;
    tg.ready();
    tg.expand();
    tg.headerColor='#0B1D15';
    tg.backgroundColor='#0B1D15';
  }catch(e){}
})();

/* â•â•â• AUTO-REFRESH on re-open (Page Visibility API) â•â•â•
   Ğ¡Ğ°Ğ¼Ñ‹Ğ¹ Ğ½Ğ°Ğ´Ñ‘Ğ¶Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ±: ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ
   Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ / Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ WebApp ÑĞ½Ğ¾Ğ²Ğ°.
   Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ½Ğ° Ğ²ÑĞµÑ… Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°Ñ… Ğ¸ Ğ²ÑĞµÑ… Ğ²ĞµÑ€ÑĞ¸ÑÑ… Telegram.
*/
(function(){
  let hiddenAt = 0;
  document.addEventListener('visibilitychange', function(){
    if(document.visibilityState === 'hidden'){
      // Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
      hiddenAt = Date.now();
    } else if(document.visibilityState === 'visible'){
      const awayMs = hiddenAt ? Date.now() - hiddenAt : 0;
      if(awayMs > 30000){
        location.reload();
      } else {
        // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ±ÑƒÑ„ĞµÑ€ Ğ¸ lastRenderedAngle â€” dial Ğ¿Ğ»Ğ°Ğ²Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾
        if(typeof bufIdx !== 'undefined'){
          bufIdx=0; bufCount=0;
          for(let i=0;i<BUF_SIZE;i++){bufCos[i]=0;bufSin[i]=0;}
          lastRenderedAngle=null;
        }
      }
    }
  });

  // Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾: focus Ğ½Ğ° Ğ¾ĞºĞ½Ğµ (Ğ´ĞµÑĞºÑ‚Ğ¾Ğ¿ / Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Android)
  window.addEventListener('focus', function(){
    if(typeof bufIdx !== 'undefined'){
      bufIdx=0; bufCount=0;
      for(let i=0;i<BUF_SIZE;i++){bufCos[i]=0;bufSin[i]=0;}
      lastRenderedAngle=null;
    }
  });
})();
const P=new URLSearchParams(location.search);
const pCity=P.get('city')||'',pLat=parseFloat(P.get('lat')),pLng=parseFloat(P.get('lng')),pLang=P.get('lang')||'ru';

/* â•â•â• i18n â•â•â• */
const L={
  ru:{ld:'ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ...',qibla:'ĞšĞ¸Ğ±Ğ»Ğ°',tasbih:'Ğ¢Ğ°ÑĞ±Ğ¸Ñ…',dist:'Ğ Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ',dir:'ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ',
      on:'ğŸ§­ ĞšĞ¾Ğ¼Ğ¿Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚',off:'ĞŸĞ¾Ğ²ĞµÑ€Ğ½Ğ¸Ñ‚Ğµ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ´Ğ»Ñ ĞºĞ°Ğ»Ğ¸Ğ±Ñ€Ğ¾Ğ²ĞºĞ¸ âˆ',face:'âœ… Ğ’Ñ‹ ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ Ğ² ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñƒ ĞºĞ¸Ğ±Ğ»Ñ‹! ğŸ•‹',km:'ĞºĞ¼',
      err:'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ',den:'Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚Ğµ Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ',
      reset:'Ğ¡Ğ±Ñ€Ğ¾Ñ',total:'Ğ’ÑĞµĞ³Ğ¾',of:'Ğ¸Ğ·',
      dirs:['Ğ¡','Ğ¡Ğ¡Ğ’','Ğ¡Ğ’','Ğ’Ğ¡Ğ’','Ğ’','Ğ’Ğ®Ğ’','Ğ®Ğ’','Ğ®Ğ®Ğ’','Ğ®','Ğ®Ğ®Ğ—','Ğ®Ğ—','Ğ—Ğ®Ğ—','Ğ—','Ğ—Ğ¡Ğ—','Ğ¡Ğ—','Ğ¡Ğ¡Ğ—']},
  uz:{ld:'Joylashuv aniqlanmoqda...',qibla:'Qibla',tasbih:'Tasbih',dist:'Masofa',dir:'Yo\'nalish',
      on:'ğŸ§­ Kompas ishlayapti',off:'Telefoni kalibrlash uchun aylantiring âˆ',face:'âœ… Siz qibla tomonga qarab turibsiz! ğŸ•‹',km:'km',
      err:'Joylashuvni aniqlab bo\'lmadi',den:'Geolokatsiyaga ruxsat bering',
      reset:'Qayta',total:'Jami',of:'dan',
      dirs:['Sh','ShShSh','ShSh','ShShSh','Sh','ShJSh','JSh','JJSh','J','JJG','JG','GJG','G','GShG','ShG','ShShG']},
  en:{ld:'Detecting location...',qibla:'Qibla',tasbih:'Tasbih',dist:'Distance',dir:'Direction',
      on:'ğŸ§­ Compass is working',off:'Rotate phone to calibrate âˆ',face:'âœ… You are facing the Qibla! ğŸ•‹',km:'km',
      err:'Unable to detect location',den:'Allow geolocation',
      reset:'Reset',total:'Total',of:'of',
      dirs:['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW']}
};
const t=L[pLang]||L.ru;
document.getElementById('lt').textContent=t.ld;
document.getElementById('tabQ').textContent=t.qibla;
document.getElementById('tabT').textContent=t.tasbih;

function switchTab(tb){
  document.querySelectorAll('.tab').forEach((e,i)=>e.classList.toggle('active',i===(tb==='qibla'?0:1)));
  document.getElementById('pg-q').classList.toggle('active',tb==='qibla');
  document.getElementById('pg-t').classList.toggle('active',tb==='tasbih');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPASS ENGINE â€” production grade
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const toRad=d=>d*Math.PI/180,toDeg=r=>r*180/Math.PI;
function qiblaAngle(lat,lng){
  const f=toRad(lat),fK=toRad(KAABA.lat),dL=toRad(KAABA.lng-lng);
  let q=toDeg(Math.atan2(Math.sin(dL),Math.cos(f)*Math.tan(fK)-Math.sin(f)*Math.cos(dL)));
  return q<0?q+360:q;
}
function haversine(lat,lng){
  const f1=toRad(lat),f2=toRad(KAABA.lat),df=toRad(KAABA.lat-lat),dl=toRad(KAABA.lng-lng);
  const a=Math.sin(df/2)**2+Math.cos(f1)*Math.cos(f2)*Math.sin(dl/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function cDir(b){return t.dirs[Math.round(b/22.5)%16]}

/* â”€â”€ Compass state â”€â”€ */
let qAngle=0;
let compassOk=false;
let gotAbsolute=false;       // true once we get absolute event
let lastRenderedAngle=null;  // last angle applied to DOM
let renderQueued=false;      // rAF guard

/*
 * CIRCULAR BUFFER for heading samples.
 * We store last N headings as unit vectors (cos,sin),
 * then compute circular mean = atan2(avg_sin, avg_cos).
 * This avoids the 359Â°/1Â° wraparound problem entirely.
 */
const BUF_SIZE=20;
const bufCos=new Float64Array(BUF_SIZE);
const bufSin=new Float64Array(BUF_SIZE);
let bufIdx=0, bufCount=0;

function pushHeading(h){
  const r=toRad(h);
  bufCos[bufIdx]=Math.cos(r);
  bufSin[bufIdx]=Math.sin(r);
  bufIdx=(bufIdx+1)%BUF_SIZE;
  if(bufCount<BUF_SIZE)bufCount++;
}

function getSmoothedHeading(){
  // Ğ–Ğ´Ñ‘Ğ¼ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 5 Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑÑĞ¼Ğ¿Ğ»Ğ¾Ğ² â€” Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ½ÑƒĞ»Ğ¸ Ğ² Ğ±ÑƒÑ„ĞµÑ€Ğµ Ñ‚ÑĞ½ÑƒÑ‚ ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğº 0
  if(bufCount<5)return null;
  let sc=0,ss=0;
  for(let i=0;i<bufCount;i++){sc+=bufCos[i];ss+=bufSin[i]}
  let avg=toDeg(Math.atan2(ss/bufCount,sc/bufCount));
  return avg<0?avg+360:avg;
}

/* â”€â”€ Sensor event handler â”€â”€ */
function onSensor(e){
  let h=null;

  // iOS: webkitCompassHeading is always absolute
  if(e.webkitCompassHeading!==undefined&&e.webkitCompassHeading!==null){
    h=e.webkitCompassHeading;
  }
  // Android absolute event or absolute flag
  else if(e.absolute===true&&e.alpha!==null){
    h=(360-e.alpha)%360;
  }
  // Fallback: relative alpha (less reliable)
  else if(e.alpha!==null){
    // Only use if we haven't gotten absolute yet
    if(!gotAbsolute) h=(360-e.alpha)%360;
  }

  if(h===null||isNaN(h))return;
  compassOk=true;
  pushHeading(h);
  scheduleRender();
}

function onAbsoluteSensor(e){
  gotAbsolute=true;
  onSensor(e);
}

/* â”€â”€ rAF render loop â€” only ONE DOM update per frame â”€â”€ */
function scheduleRender(){
  if(renderQueued)return;
  renderQueued=true;
  requestAnimationFrame(doRender);
}

function doRender(){
  renderQueued=false;
  const dial=document.getElementById('dial');
  if(!dial)return;

  const heading=getSmoothedHeading();
  // ĞĞµ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑĞ¼Ğ¿Ğ»Ğ¾Ğ² â€” Ğ¸Ğ½Ğ°Ñ‡Ğµ dial Ğ¿Ñ€Ñ‹Ğ³Ğ°ĞµÑ‚ Ğº qAngle
  if(heading===null)return;

  const targetAngle=qAngle-heading;

  if(lastRenderedAngle!==null){
    // Compute shortest angular delta (always -180..+180)
    let delta=((targetAngle-lastRenderedAngle)%360+540)%360-180;
    // Dead zone: ignore noise smaller than 2Â°
    if(Math.abs(delta)<2.0)return;
    // Accumulate unbounded â€” do NOT normalize, or next delta will be wrong
    lastRenderedAngle+=delta;
  }else{
    lastRenderedAngle=targetAngle;
  }

  dial.style.transform=`rotate(${lastRenderedAngle}deg)`;

  // Alignment check
  const diff=Math.abs(((heading-qAngle)%360+540)%360-180);
  const el=document.getElementById('aligned');
  if(el){
    if(diff<5)el.classList.add('show');
    else el.classList.remove('show');
  }

  // Update hint
  const hint=document.getElementById('hint');
  if(hint&&!hint.dataset.on){
    hint.classList.remove('off');
    hint.querySelector('.tx').textContent=t.on;
    hint.dataset.on='1';
  }
}

/* â”€â”€ Start compass listeners with correct priority â”€â”€ */
function startCompass(){
  // PRIORITY 1: deviceorientationabsolute (Chrome Android â€” true north)
  // This gives absolute heading and is the most reliable on Android
  if('ondeviceorientationabsolute' in window||window.DeviceOrientationAbsoluteEvent){
    window.addEventListener('deviceorientationabsolute',onAbsoluteSensor,true);
  }

  // PRIORITY 2: deviceorientation (iOS uses webkitCompassHeading from here)
  if(window.DeviceOrientationEvent){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      // iOS 13+ permission
      DeviceOrientationEvent.requestPermission().then(s=>{
        if(s==='granted')window.addEventListener('deviceorientation',onSensor,true);
      }).catch(()=>{});
    }else{
      window.addEventListener('deviceorientation',onSensor,true);
    }
  }
}

/* â•â•â• RENDER QIBLA PAGE â•â•â• */
function renderQibla(lat,lng,city){
  qAngle=qiblaAngle(lat,lng);
  const d=haversine(lat,lng),dir=cDir(qAngle),S=270,cx=S/2,cy=S/2;

  let ticks='';
  for(let i=0;i<360;i+=5){
    const mj=i%30===0,md=i%15===0,r1=mj?118:(md?122:125),r2=135,a=toRad(i-90);
    ticks+=`<line x1="${cx+r1*Math.cos(a)}" y1="${cy+r1*Math.sin(a)}" x2="${cx+r2*Math.cos(a)}" y2="${cy+r2*Math.sin(a)}" stroke="${mj?'rgba(201,168,76,.6)':'rgba(201,168,76,.15)'}" stroke-width="${mj?1.5:.5}"/>`;
  }
  let cs='';
  [[0,'N','rgba(201,168,76,.85)',15],[90,'E','rgba(201,168,76,.4)',12],[180,'S','rgba(201,168,76,.4)',12],[270,'W','rgba(201,168,76,.4)',12]].forEach(([a,l,c,fs])=>{
    const r=103,ar=toRad(a-90);
    cs+=`<text x="${cx+r*Math.cos(ar)}" y="${cy+r*Math.sin(ar)+4}" text-anchor="middle" fill="${c}" font-family="Amiri,serif" font-size="${fs}" font-weight="700">${l}</text>`;
  });
  [30,60,120,150,210,240,300,330].forEach(dg=>{
    const r=92,ar=toRad(dg-90);
    cs+=`<text x="${cx+r*Math.cos(ar)}" y="${cy+r*Math.sin(ar)+3}" text-anchor="middle" fill="rgba(201,168,76,.2)" font-family="Noto Sans" font-size="7">${dg}Â°</text>`;
  });

  document.getElementById('ct').innerHTML=`
    <div class="hd"><div class="ar">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù</div><h1>ğŸ•‹ ${t.qibla}</h1>${city?`<div class="city">ğŸ“ <b>${decodeURIComponent(city)}</b></div>`:''}</div>
    <div class="deg">${qAngle.toFixed(1)}Â°<span class="sm">${dir}</span></div>
    <div class="hint off" id="hint"><div class="dot"></div><span class="tx">${t.off}</span></div>
    <div class="cmp"><div class="cmp-bg"></div>
      <svg class="arrow" viewBox="0 0 ${S} ${S}">
        <defs>
          <linearGradient id="ag" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#E8D48B"/><stop offset="100%" stop-color="#9A7B2E"/></linearGradient>
          <filter id="gw"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <g filter="url(#gw)">
          <polygon points="${cx},20 ${cx-13},${cy-10} ${cx},${cy-24} ${cx+13},${cy-10}" fill="url(#ag)"/>
          <polygon points="${cx},${S-20} ${cx-9},${cy+10} ${cx},${cy+24} ${cx+9},${cy+10}" fill="rgba(201,168,76,.12)"/>
        </g>
        <circle cx="${cx}" cy="${cy}" r="5" fill="#0B1D15" stroke="#C9A84C" stroke-width="2"/>
        <circle cx="${cx}" cy="${cy}" r="2" fill="#C9A84C"/>
      </svg>
      <div class="dial" id="dial"><svg viewBox="0 0 ${S} ${S}">${ticks}${cs}<text x="${cx}" y="13" text-anchor="middle" font-size="19">ğŸ•‹</text></svg></div>
    </div>
    <div class="aligned" id="aligned">${t.face}</div>
    <div class="ibar">
      <div class="ib"><div class="l">${t.dir}</div><div class="v">${dir}</div></div>
      <div class="ib"><div class="l">${t.dist}</div><div class="v">${d.toFixed(0)}<span class="u"> ${t.km}</span></div></div>
      <div class="ib"><div class="l">${t.qibla}</div><div class="v">${qAngle.toFixed(1)}Â°</div></div>
    </div>`;

  lastRenderedAngle=null;
  startCompass();
}

function showErr(m){document.getElementById('ct').innerHTML=`<div class="ld"><p class="er">âš ï¸ ${m}</p></div>`}

/* â•â•â• TASBIH â•â•â• */
const DHIKR=[
  {ar:'Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù',tr:'Ğ¡ÑƒĞ±Ñ…Ğ°Ğ½Ğ°Ğ»Ğ»Ğ°Ñ…',truz:'Subhanalloh',tren:'SubhanAllah',mean:'ĞŸÑ€ĞµÑ‡Ğ¸ÑÑ‚ ĞĞ»Ğ»Ğ°Ñ…',meanuz:'Alloh pok',meanen:'Glory be to Allah',target:33},
  {ar:'Ù±Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù°Ù‡Ù',tr:'ĞĞ»ÑŒÑ…Ğ°Ğ¼Ğ´ÑƒĞ»Ğ¸Ğ»Ğ»ÑÑ…',truz:'Alhamdulillah',tren:'Alhamdulillah',mean:'Ğ¥Ğ²Ğ°Ğ»Ğ° ĞĞ»Ğ»Ğ°Ñ…Ñƒ',meanuz:'Allohga hamd',meanen:'Praise be to Allah',target:33},
  {ar:'Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù Ø£ÙÙƒÙ’Ø¨ÙØ±Ù',tr:'ĞĞ»Ğ»Ğ°Ñ…Ñƒ ĞĞºĞ±Ğ°Ñ€',truz:'Allohu Akbar',tren:'Allahu Akbar',mean:'ĞĞ»Ğ»Ğ°Ñ… Ğ’ĞµĞ»Ğ¸Ğº',meanuz:'Alloh Buyuk',meanen:'Allah is the Greatest',target:33},
  {ar:'Ù„ÙØ§ Ø¥ÙÙ„ÙÙ°Ù‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù',tr:'Ğ›Ñ Ğ¸Ğ»ÑÑ…Ğ° Ğ¸Ğ»Ğ»ÑĞ»Ğ»Ğ°Ñ…',truz:'La ilaha illalloh',tren:'La ilaha illAllah',mean:'ĞĞµÑ‚ Ğ±Ğ¾Ğ³Ğ°, ĞºÑ€Ğ¾Ğ¼Ğµ ĞĞ»Ğ»Ğ°Ñ…Ğ°',meanuz:'Allohdan boshqa iloh yo\'q',meanen:'There is no god but Allah',target:100},
  {ar:'Ø£ÙØ³Ù’ØªÙØºÙ’ÙÙØ±Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù',tr:'ĞÑÑ‚Ğ°Ğ³Ñ„Ğ¸Ñ€ÑƒĞ»Ğ»Ğ°Ñ…',truz:'Astaghfirulloh',tren:'Astaghfirullah',mean:'ĞŸÑ€Ğ¾ÑˆÑƒ Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ñ Ñƒ ĞĞ»Ğ»Ğ°Ñ…Ğ°',meanuz:'Allohdan mag\'firat so\'rayman',meanen:'I seek forgiveness from Allah',target:100},
  {ar:'Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù ÙˆÙØ¨ÙØ­ÙÙ…Ù’Ø¯ÙÙ‡Ù',tr:'Ğ¡ÑƒĞ±Ñ…Ğ°Ğ½Ğ°Ğ»Ğ»Ğ°Ñ…Ğ¸ Ğ²Ğ° Ğ±Ğ¸Ñ…Ğ°Ğ¼Ğ´Ğ¸Ñ…',truz:'Subhanallahi va bihamdihi',tren:'SubhanAllahi wa bihamdihi',mean:'ĞŸÑ€ĞµÑ‡Ğ¸ÑÑ‚ ĞĞ»Ğ»Ğ°Ñ… Ğ¸ Ñ…Ğ²Ğ°Ğ»Ğ° Ğ•Ğ¼Ñƒ',meanuz:'Alloh pok va Unga hamd',meanen:'Glory and praise be to Allah',target:100},
];
let curD=0,cnt=0,totCnt=0,tgt=33;
const CIRC=2*Math.PI*100;
function gTr(d){return pLang==='uz'?d.truz:pLang==='en'?d.tren:d.tr}
function gMn(d){return pLang==='uz'?d.meanuz:pLang==='en'?d.meanen:d.mean}

function renderTasbih(){
  const d=DHIKR[curD];tgt=d.target;
  document.getElementById('tc').innerHTML=`
    <div class="dhikr-selector">${DHIKR.map((dh,i)=>`<div class="dhikr-btn${i===curD?' active':''}" onclick="selD(${i})">${gTr(dh)}</div>`).join('')}</div>
    <div class="tasbih-display">
      <div class="tasbih-arabic">${d.ar}</div>
      <div class="tasbih-translit">${gTr(d)}</div>
      <div class="tasbih-meaning">${gMn(d)}</div>
    </div>
    <div class="counter-wrap" id="cw" onclick="inc(event)">
      <svg class="progress-ring" viewBox="0 0 220 220"><circle class="progress-bg" cx="110" cy="110" r="100"/><circle class="progress-bar" id="pb" cx="110" cy="110" r="100" stroke-dasharray="${CIRC}" stroke-dashoffset="${CIRC}"/></svg>
      <div class="tap-area"><div class="count-num" id="cn">0</div><div class="count-target" id="cgt">0 ${t.of} ${tgt}</div><div class="count-total" id="ctt">${t.total}: 0</div></div>
    </div>
    <div class="tasbih-controls"><div class="ctrl-btn" onclick="rstCnt()">â†º</div></div>
    <div class="target-selector">${[33,99,100,500,1000].map(n=>`<div class="target-btn${n===tgt?' active':''}" onclick="setTgt(${n})">${n}</div>`).join('')}</div>`;
  updProg();
}
function selD(i){curD=i;cnt=0;renderTasbih()}
function setTgt(n){tgt=n;cnt=0;renderTasbih()}
function inc(ev){
  cnt++;totCnt++;
  try{navigator.vibrate&&navigator.vibrate(15)}catch(e){}
  try{Telegram.WebApp.HapticFeedback.impactOccurred('light')}catch(e){}
  const w=document.getElementById('cw'),rc=w.getBoundingClientRect(),rp=document.createElement('div');
  rp.className='ripple';rp.style.width=rp.style.height='60px';
  rp.style.left=(ev.clientX-rc.left-30)+'px';rp.style.top=(ev.clientY-rc.top-30)+'px';
  w.appendChild(rp);setTimeout(()=>rp.remove(),500);
  if(cnt>=tgt){cnt=0;try{navigator.vibrate&&navigator.vibrate([30,50,30])}catch(e){}try{Telegram.WebApp.HapticFeedback.notificationOccurred('success')}catch(e){}}
  updProg();
}
function rstCnt(){cnt=0;totCnt=0;updProg();try{navigator.vibrate&&navigator.vibrate(10)}catch(e){}}
function updProg(){
  const n=document.getElementById('cn'),g=document.getElementById('cgt'),tt=document.getElementById('ctt'),b=document.getElementById('pb');
  if(!n)return;n.textContent=cnt;g.textContent=`${cnt} ${t.of} ${tgt}`;tt.textContent=`${t.total}: ${totCnt}`;
  b.style.strokeDashoffset=CIRC*(1-cnt/tgt);
}

/* â•â•â• INIT â•â•â• */
renderTasbih();
(function(){
  if(!isNaN(pLat)&&!isNaN(pLng)){
    renderQibla(pLat,pLng,pCity);
    return;
  }
  if(!navigator.geolocation){showErr(t.err);return}
  // ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ñ„Ğ¸ĞºÑ
  navigator.geolocation.getCurrentPosition(
    p=>renderQibla(p.coords.latitude,p.coords.longitude,pCity||''),
    e=>showErr(e.code===1?t.den:t.err),
    {enableHighAccuracy:true,timeout:10000,maximumAge:0}
  );
  // ĞĞµĞ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ½Ğ¾Ğµ ÑĞ»ĞµĞ¶ĞµĞ½Ğ¸Ğµ â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğ¸
  navigator.geolocation.watchPosition(
    p=>renderQibla(p.coords.latitude,p.coords.longitude,pCity||''),
    ()=>{},
    {enableHighAccuracy:true,timeout:15000,maximumAge:0}
  );
})();
</script>
</body>
</html>
